<!DOCTYPE html>

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUBG AR - P2P ë°°í‹€ë¡œì–„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Arial', sans-serif;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        color: white;
        overflow: hidden;
        height: 100vh;
        user-select: none;
    }

    .game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .lobby {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        text-align: center;
        padding: 20px;
    }

    .lobby h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 0 0 20px #00ff41;
    }

    .lobby p {
        font-size: 1.1rem;
        opacity: 0.8;
        margin-bottom: 30px;
    }

    .name-display {
        font-size: 1.3rem;
        color: #00ff41;
        margin: 20px 0;
        padding: 15px;
        background: rgba(0, 255, 65, 0.1);
        border: 2px solid #00ff41;
        border-radius: 10px;
        min-width: 200px;
    }

    .room-code-display {
        font-size: 1.1rem;
        color: #ffaa00;
        margin: 15px 0;
        padding: 10px;
        background: rgba(255, 170, 0, 0.1);
        border: 2px solid #ffaa00;
        border-radius: 8px;
    }

    .btn-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }

    .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        min-width: 200px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        border: 2px solid #ff4444;
    }

    .btn-secondary {
        background: linear-gradient(135deg, #4ecdc4, #44a08d);
        color: white;
        border: 2px solid #00ff41;
    }

    .btn-info {
        background: linear-gradient(135deg, #ffa726, #ffcc02);
        color: #333;
        border: 2px solid #ffaa00;
    }

    .btn:active {
        transform: scale(0.95);
    }

    .btn:hover {
        filter: brightness(1.1);
    }

    .game-screen {
        flex: 1;
        position: relative;
        background: radial-gradient(circle at center, #0f3460, #16537e, #1a1a2e);
    }

    .hud {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .hud-panel {
        background: rgba(0, 0, 0, 0.8);
        padding: 12px;
        border-radius: 10px;
        border: 2px solid #00ff41;
        backdrop-filter: blur(5px);
    }

    .health-bar {
        width: 120px;
        height: 8px;
        background: #333;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
    }

    .health-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff41);
        transition: width 0.5s;
    }

    .crosshair {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        z-index: 50;
        pointer-events: none;
    }

    .crosshair::before,
    .crosshair::after {
        content: '';
        position: absolute;
        background: #00ff41;
        box-shadow: 0 0 15px #00ff41;
        border-radius: 2px;
    }

    .crosshair::before {
        width: 3px;
        height: 25px;
        top: 12px;
        left: 23px;
    }

    .crosshair::after {
        width: 25px;
        height: 3px;
        top: 23px;
        left: 12px;
    }

    .controls {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 100;
    }

    .shoot-btn {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: radial-gradient(circle, #ff4444, #aa0000);
        border: 3px solid #ff6666;
        color: white;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.1s;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
    }

    .shoot-btn:active {
        transform: scale(0.9);
        box-shadow: 0 0 30px rgba(255, 68, 68, 0.8);
    }

    .player-radar {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 100px;
        height: 100px;
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #00ff41;
        border-radius: 50%;
        z-index: 90;
    }

    .player-list {
        position: absolute;
        top: 140px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 10px;
        border: 2px solid #00ff41;
        max-height: 200px;
        min-width: 180px;
        overflow-y: auto;
    }

    .player-item {
        padding: 8px 0;
        border-bottom: 1px solid #333;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
    }

    .player-item:last-child {
        border-bottom: none;
    }

    .distance-display {
        position: absolute;
        bottom: 140px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 12px 20px;
        border-radius: 20px;
        border: 2px solid #00ff41;
        font-size: 18px;
        font-weight: bold;
    }

    .status-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 200;
    }

    .status-modal {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        padding: 30px;
        border-radius: 15px;
        border: 3px solid #00ff41;
        text-align: center;
        max-width: 300px;
        width: 90%;
    }

    .status-modal h3 {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: #00ff41;
    }

    .hidden {
        display: none !important;
    }

    .hit-effect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: radial-gradient(circle, rgba(255, 0, 0, 0.3), transparent);
        pointer-events: none;
        animation: hitFlash 0.5s ease-out;
        z-index: 150;
    }

    @keyframes hitFlash {
        0% { opacity: 0; }
        50% { opacity: 1; }
        100% { opacity: 0; }
    }

    .connection-status {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 15px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 20px;
        font-size: 12px;
        z-index: 110;
    }

    .connected { border: 2px solid #00ff41; color: #00ff41; }
    .connecting { border: 2px solid #ffaa00; color: #ffaa00; }
    .disconnected { border: 2px solid #ff4444; color: #ff4444; }

    @media (max-width: 480px) {
        .lobby h1 { font-size: 2rem; }
        .btn { font-size: 14px; padding: 12px 25px; }
        .hud { left: 10px; right: 10px; top: 10px; }
        .controls { bottom: 20px; }
    }
</style>
```

</head>
<body>
    <div class="game-container">
        <!-- ë¡œë¹„ í™”ë©´ -->
        <div id="lobbyScreen" class="lobby">
            <h1>ğŸ¯ PUBG AR</h1>
            <p>ë¡œê·¸ì¸ ì—†ëŠ” P2P ë°°í‹€ë¡œì–„</p>

```
        <div class="name-display">
            <div>ğŸ® <span id="playerNameDisplay"></span></div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="createRoom()">
                ğŸ  ë°© ë§Œë“¤ê¸°
            </button>
            <button class="btn btn-secondary" onclick="showJoinRoom()">
                ğŸšª ë°© ì°¸ê°€í•˜ê¸°
            </button>
            <button class="btn btn-info" onclick="generateNewName()">
                ğŸ² ë‹‰ë„¤ì„ ë³€ê²½
            </button>
        </div>
        
        <div style="margin-top: 30px; font-size: 13px; opacity: 0.7; line-height: 1.4;">
            <p>ğŸ“± ìŠ¤ë§ˆíŠ¸í°ì„ ì´ì²˜ëŸ¼ ë“¤ê³  ì¡°ì¤€</p>
            <p>ğŸ¯ ë¹¨ê°„ ë²„íŠ¼ìœ¼ë¡œ ë°œì‚¬!</p>
            <p>âš¡ ì™„ì „ ë¬´ë£Œ, ë¡œê·¸ì¸ ë¶ˆí•„ìš”</p>
        </div>
    </div>

    <!-- ë°© ì°¸ê°€ í™”ë©´ -->
    <div id="joinRoomScreen" class="lobby hidden">
        <h2>ğŸšª ë°© ì°¸ê°€</h2>
        <p>ì¹œêµ¬ê°€ ì¤€ ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        
        <div style="margin: 30px 0;">
            <input type="text" id="roomCodeInput" 
                   style="padding: 15px; font-size: 18px; border: 2px solid #00ff41; border-radius: 8px; background: rgba(0,0,0,0.7); color: white; text-align: center; width: 200px;"
                   placeholder="ë°© ì½”ë“œ ì…ë ¥" maxlength="6">
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="joinRoom()">
                âœ… ì°¸ê°€í•˜ê¸°
            </button>
            <button class="btn btn-secondary" onclick="backToLobby()">
                â† ë’¤ë¡œê°€ê¸°
            </button>
        </div>
    </div>

    <!-- ë°© ëŒ€ê¸° í™”ë©´ -->
    <div id="waitingScreen" class="lobby hidden">
        <h2>ğŸ  ë°© ëŒ€ê¸°ì‹¤</h2>
        <div class="room-code-display">
            ë°© ì½”ë“œ: <strong id="roomCodeDisplay"></strong>
        </div>
        <p>ì¹œêµ¬ë“¤ì—ê²Œ ìœ„ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”!</p>
        
        <div id="waitingPlayers" style="margin: 30px 0;">
            <h3>ì°¸ê°€ì ëª©ë¡</h3>
            <div id="playersList"></div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="startGame()" id="startGameBtn">
                ğŸš€ ê²Œì„ ì‹œì‘ (2ëª… ì´ìƒ)
            </button>
            <button class="btn btn-secondary" onclick="leaveRoom()">
                ğŸšª ë°© ë‚˜ê°€ê¸°
            </button>
        </div>
    </div>

    <!-- ê²Œì„ í™”ë©´ -->
    <div id="gameScreen" class="game-screen hidden">
        <div class="connection-status connecting" id="connectionStatus">
            ì—°ê²° ì¤‘...
        </div>
        
        <div class="hud">
            <div class="hud-panel">
                <div>â¤ï¸ <span id="healthDisplay">100</span>/100</div>
                <div class="health-bar">
                    <div class="health-fill" id="healthBar" style="width: 100%;"></div>
                </div>
                <div>ğŸ† í‚¬: <span id="killDisplay">0</span></div>
            </div>
            
            <div class="hud-panel">
                <div>ğŸ‘¥ ìƒì¡´: <span id="aliveDisplay">0</span></div>
                <div>ğŸ“¡ ê±°ë¦¬: <span id="nearestDistance">-</span>m</div>
            </div>
        </div>

        <div class="crosshair"></div>
        
        <div class="player-radar" id="radar">
            <!-- ë ˆì´ë” ì ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>

        <div class="player-list">
            <h4 style="margin-bottom: 10px;">í”Œë ˆì´ì–´</h4>
            <div id="gamePlayersList"></div>
        </div>

        <div class="distance-display" id="distanceInfo">
            ì¡°ì¤€ ì¤‘: <span id="targetName">-</span>
        </div>

        <div class="controls">
            <button class="btn btn-secondary" onclick="leaveGame()" style="font-size: 12px; padding: 8px 15px;">
                ğŸšª ë‚˜ê°€ê¸°
            </button>
            
            <button class="shoot-btn" id="shootButton" 
                    onmousedown="startShooting()" onmouseup="stopShooting()"
                    ontouchstart="startShooting(event)" ontouchend="stopShooting(event)">
                ğŸ”«
            </button>
            
            <button class="btn btn-secondary" onclick="reload()" style="font-size: 12px; padding: 8px 15px;">
                ğŸ”„ ì¬ì¥ì „
            </button>
        </div>
    </div>

    <!-- ìƒíƒœ ë©”ì‹œì§€ ëª¨ë‹¬ -->
    <div id="statusOverlay" class="status-overlay hidden">
        <div class="status-modal">
            <h3 id="statusTitle"></h3>
            <p id="statusMessage"></p>
            <button class="btn btn-primary" onclick="closeStatus()" style="margin-top: 15px;">
                í™•ì¸
            </button>
        </div>
    </div>
</div>

<script>
    // ê²Œì„ ìƒíƒœ ê´€ë¦¬
    let gameState = {
        screen: 'lobby', // lobby, joinRoom, waiting, game
        playerName: '',
        roomCode: '',
        isHost: false,
        health: 100,
        kills: 0,
        ammo: 30,
        isReloading: false,
        position: { lat: 0, lng: 0, accuracy: 0 },
        orientation: { alpha: 0, beta: 0, gamma: 0 },
        players: new Map(),
        connections: new Map(),
        lastShot: 0,
        gameStartTime: 0
    };

    // P2P ì—°ê²° ì„¤ì •
    const rtcConfig = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    };

    // ëœë¤ ë‹‰ë„¤ì„ ìƒì„±
    const adjectives = ['ìš©ê°í•œ', 'ë¹ ë¥¸', 'ê°•ë ¥í•œ', 'ë˜‘ë˜‘í•œ', 'ì‹ ë¹„í•œ', 'ì°¨ê°€ìš´', 'ëœ¨ê±°ìš´', 'ë‚ ì¹´ë¡œìš´', 'ì¡°ìš©í•œ', 'ê±°ëŒ€í•œ'];
    const nouns = ['ì „ì‚¬', 'ì‚¬ëƒ¥ê¾¼', 'ì €ê²©ìˆ˜', 'íŠ¹ê³µëŒ€', 'ìš©ë³‘', 'ë‹Œì', 'í•´ì ', 'ê¸°ì‚¬', 'ë§ˆë²•ì‚¬', 'ë¡œë´‡'];

    function generateRandomName() {
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const noun = nouns[Math.floor(Math.random() * nouns.length)];
        const num = Math.floor(Math.random() * 1000);
        return `${adj}${noun}${num}`;
    }

    // ì´ˆê¸°í™”
    function init() {
        gameState.playerName = generateRandomName();
        document.getElementById('playerNameDisplay').textContent = gameState.playerName;
        
        // ìœ„ì¹˜ ì •ë³´ ê¶Œí•œ ìš”ì²­
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(updatePosition, handleLocationError, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            });
        }
        
        // ë””ë°”ì´ìŠ¤ ë°©í–¥ ê¶Œí•œ ìš”ì²­
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            // iOS
            DeviceOrientationEvent.requestPermission().then(response => {
                if (response === 'granted') {
                    window.addEventListener('deviceorientation', updateOrientation);
                }
            });
        } else {
            // Android
            window.addEventListener('deviceorientation', updateOrientation);
        }
        
        // í„°ì¹˜ ì´ë²¤íŠ¸ ë°©ì§€ (ê²Œì„ ì¤‘ ìŠ¤í¬ë¡¤ ë°©ì§€)
        document.addEventListener('touchmove', function(e) {
            if (gameState.screen === 'game') {
                e.preventDefault();
            }
        }, { passive: false });
    }

    function updatePosition(position) {
        gameState.position = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy
        };
        broadcastPosition();
    }

    function handleLocationError(error) {
        console.log('ìœ„ì¹˜ ì •ë³´ ì˜¤ë¥˜:', error.message);
        // ê°€ìƒ ìœ„ì¹˜ ì‚¬ìš© (í…ŒìŠ¤íŠ¸ìš©)
        gameState.position = {
            lat: 37.5665 + (Math.random() - 0.5) * 0.01,
            lng: 126.9780 + (Math.random() - 0.5) * 0.01,
            accuracy: 10
        };
    }

    function updateOrientation(event) {
        gameState.orientation = {
            alpha: event.alpha || 0,
            beta: event.beta || 0,
            gamma: event.gamma || 0
        };
    }

    // í™”ë©´ ì „í™˜
    function showScreen(screenName) {
        document.querySelectorAll('.lobby, .game-screen').forEach(el => el.classList.add('hidden'));
        
        switch(screenName) {
            case 'lobby':
                document.getElementById('lobbyScreen').classList.remove('hidden');
                break;
            case 'joinRoom':
                document.getElementById('joinRoomScreen').classList.remove('hidden');
                break;
            case 'waiting':
                document.getElementById('waitingScreen').classList.remove('hidden');
                break;
            case 'game':
                document.getElementById('gameScreen').classList.remove('hidden');
                break;
        }
        
        gameState.screen = screenName;
    }

    // ë‹‰ë„¤ì„ ì¬ìƒì„±
    function generateNewName() {
        gameState.playerName = generateRandomName();
        document.getElementById('playerNameDisplay').textContent = gameState.playerName;
    }

    // ë°© ë§Œë“¤ê¸°
    function createRoom() {
        gameState.roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        gameState.isHost = true;
        
        document.getElementById('roomCodeDisplay').textContent = gameState.roomCode;
        showScreen('waiting');
        
        // ë°©ì¥ì€ ìì‹ ì„ í”Œë ˆì´ì–´ ëª©ë¡ì— ì¶”ê°€
        updatePlayersList([{
            id: 'host',
            name: gameState.playerName,
            isHost: true
        }]);
    }

    // ë°© ì°¸ê°€ í™”ë©´ í‘œì‹œ
    function showJoinRoom() {
        showScreen('joinRoom');
        document.getElementById('roomCodeInput').focus();
    }

    // ë°© ì°¸ê°€
    function joinRoom() {
        const roomCode = document.getElementById('roomCodeInput').value.toUpperCase();
        if (roomCode.length !== 6) {
            showStatus('ì˜¤ë¥˜', 'ë°© ì½”ë“œëŠ” 6ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
        
        gameState.roomCode = roomCode;
        gameState.isHost = false;
        
        // ì‹¤ì œë¡œëŠ” P2P ì—°ê²°ì„ ì‹œë„í•´ì•¼ í•˜ì§€ë§Œ, ë°ëª¨ë¥¼ ìœ„í•´ ëŒ€ê¸°ì‹¤ë¡œ ì´ë™
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        showScreen('waiting');
        
        // ê°€ìƒì˜ ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ ì¶”ê°€ (ë°ëª¨ìš©)
        updatePlayersList([
            { id: 'host', name: 'ë°©ì¥', isHost: true },
            { id: 'me', name: gameState.playerName, isHost: false }
        ]);
    }

    // ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°
    function backToLobby() {
        showScreen('lobby');
    }

    // ë°© ë‚˜ê°€ê¸°
    function leaveRoom() {
        gameState.connections.forEach(conn => conn.close());
        gameState.connections.clear();
        gameState.players.clear();
        showScreen('lobby');
    }

    // í”Œë ˆì´ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸
    function updatePlayersList(players) {
        const container = document.getElementById('playersList');
        container.innerHTML = '';
        
        players.forEach(player => {
            const playerDiv = document.createElement('div');
            playerDiv.style.cssText = 'padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 5px; display: flex; justify-content: space-between; align-items: center;';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = player.name;
            
            const statusSpan = document.createElement('span');
            statusSpan.textContent = player.isHost ? 'ğŸ‘‘' : 'ğŸ®';
            statusSpan.style.fontSize = '16px';
            
            playerDiv.appendChild(nameSpan);
            playerDiv.appendChild(statusSpan);
            container.appendChild(playerDiv);
        });
        
        // ì‹œì‘ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        const startBtn = document.getElementById('startGameBtn');
        if (players.length >= 2 && gameState.isHost) {
            startBtn.disabled = false;
            startBtn.style.opacity = '1';
        } else {
            startBtn.disabled = true;
            startBtn.style.opacity = '0.5';
        }
    }

    // ê²Œì„ ì‹œì‘
    function startGame() {
        if (gameState.screen !== 'waiting') return;
        
        gameState.gameStartTime = Date.now();
        gameState.health = 100;
        gameState.kills = 0;
        gameState.ammo = 30;
        
        showScreen('game');
        
        // ê°€ìƒì˜ í”Œë ˆì´ì–´ë“¤ ìƒì„± (ë°ëª¨ìš©)
        for (let i = 1; i <= 3; i++) {
            const virtualPlayer = {
                id: `player_${i}`,
                name: generateRandomName(),
                health: 100,
                position: {
                    lat: gameState.position.lat + (Math.random() - 0.5) * 0.002,
                    lng: gameState.position.lng + (Math.random() - 0.5) * 0.002
                },
                lastSeen: Date.now()
            };
            gameState.players.set(virtualPlayer.id, virtualPlayer);
        }
        
        updateGameUI();
        startGameLoop();
    }

    // ê²Œì„ UI ì—…ë°ì´íŠ¸
    function updateGameUI() {
        document.getElementById('healthDisplay').textContent = gameState.health;
        document.getElementById('healthBar').style.width = gameState.health + '%';
        document.getElementById('killDisplay').textContent = gameState.kills;
        document.getElementById('aliveDisplay').textContent = gameState.players.size + 1;
        
        // í”Œë ˆì´ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸
        const gamePlayersList = document.getElementById('gamePlayersList');
        gamePlayersList.innerHTML = '';
        
        let nearestDistance = Infinity;
        let nearestPlayer = null;
        
        gameState.players.forEach(player => {
            const distance = calculateDistance(gameState.position, player.position);
            
            if (distance < nearestDistance) {
                nearestDistance = distance;
                nearestPlayer = player;
            }
            
            const playerItem = document.createElement('div');
            playerItem.className = 'player-item';
            playerItem.innerHTML = `
                <span>${player.name}</span>
                <span>${Math.round(distance)}m</span>
            `;
            gamePlayersList.appendChild(playerItem);
        });
        
        if (nearestPlayer) {
            document.getElementById('nearestDistance').textContent = Math.round(nearestDistance);
            document.getElementById('targetName').textContent = nearestPlayer.name;
        }
    }

    // ê±°ë¦¬ ê³„ì‚° (í•˜ë²„ì‚¬ì¸ ê³µì‹)
    function calculateDistance(pos1, pos2) {
        const R = 6371000; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
        const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
        const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // ê²Œì„ ë£¨í”„
    function startGameLoop() {
        gameState.gameLoop = setInterval(() => {
            updateGameUI();
            updateRadar();
            
            // AI í”Œë ˆì´ì–´ë“¤ ì´ë™ (ë°ëª¨ìš©)
            gameState.players.forEach(player => {
                player.position.lat += (Math.random() - 0.5) * 0.0001;
                player.position.lng += (Math.random() - 0.5) * 0.0001;
            });
            
        }, 1000);
    }

    // ë ˆì´ë” ì—…ë°ì´íŠ¸
    function updateRadar() {
        const radar = document.getElementById('radar');
        const dots = radar.querySelectorAll('.radar-dot');
        dots.forEach(dot => dot.remove());
        
        gameState.players.forEach(player => {
            const distance = calculateDistance(gameState.position, player.position);
            if (distance < 200) { // 200m ì´ë‚´ë§Œ í‘œì‹œ
                const dot = document.createElement('div');
                dot.className = 'radar-dot';
                dot.style.cssText = `
                    position: absolute;
                    width: 6px;
                    height: 6px;
                    background: #ff4444;
                    border-radius: 50%;
                    transform: translate(-50%, -50%);
                    left: ${50 + (distance / 200) * 40 * Math.cos(Math.random() * Math.PI * 2)}%;
                    top: ${50 + (distance / 200) * 40 * Math.sin(Math.random() * Math.PI * 2)}%;
                    box-shadow: 0 0 8px #ff4444;
                `;
                radar.appendChild(dot);
            }
        });
    }

    // ë°œì‚¬ ì‹œì‘
    function startShooting(event) {
        if (event) event.preventDefault();
        
        if (gameState.screen !== 'game' || gameState.ammo <= 0 || gameState.isReloading) {
            return;
        }
        
        const now = Date.now();
        if (now - gameState.lastShot < 200) { // ë°œì‚¬ ì†ë„ ì œí•œ (200ms)
            return;
        }
        
        gameState.lastShot = now;
        gameState.ammo--;
        
        // ë°œì‚¬ íš¨ê³¼
        const shootBtn = document.getElementById('shootButton');
        shootBtn.style.transform = 'scale(0.9)';
        shootBtn.style.boxShadow = '0 0 30px rgba(255, 68, 68, 1)';
        
        // ì§„ë™ íš¨ê³¼ (ì§€ì›í•˜ëŠ” ë””ë°”ì´ìŠ¤ì—ì„œ)
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
        
        // ëª…ì¤‘ íŒì •
        checkHit();
        
        // íƒ„ì•½ ë¶€ì¡± ì‹œ ìë™ ì¬ì¥ì „
        if (gameState.ammo <= 0) {
            setTimeout(reload, 500);
        }
    }

    // ë°œì‚¬ ì¢…ë£Œ
    function stopShooting(event) {
        if (event) event.preventDefault();
        
        const shootBtn = document.getElementById('shootButton');
        shootBtn.style.transform = 'scale(1)';
        shootBtn.style.boxShadow = '0 0 20px rgba(255, 68, 68, 0.5)';
    }

    // ëª…ì¤‘ íŒì •
    function checkHit() {
        let nearestPlayer = null;
        let nearestDistance = Infinity;
        
        // ê°€ì¥ ê°€ê¹Œìš´ í”Œë ˆì´ì–´ ì°¾ê¸°
        gameState.players.forEach(player => {
            const distance = calculateDistance(gameState.position, player.position);
            if (distance < nearestDistance) {
                nearestDistance = distance;
                nearestPlayer = player;
            }
        });
        
        if (nearestPlayer && nearestDistance < 50) { // 50m ì´ë‚´ì—ì„œë§Œ ëª…ì¤‘ ê°€ëŠ¥
            // ì¡°ì¤€ ì •í™•ë„ ê³„ì‚° (ê±°ë¦¬ì™€ ê°ë„ ê¸°ë°˜)
            const accuracy = Math.max(0, 1 - (nearestDistance / 50));
            const hitChance = accuracy * 0.7; // ìµœëŒ€ 70% ëª…ì¤‘ë¥ 
            
            if (Math.random() < hitChance) {
                // ëª…ì¤‘!
                const damage = Math.floor(Math.random() * 30) + 20; // 20-50 ë°ë¯¸ì§€
                nearestPlayer.health = Math.max(0, nearestPlayer.health - damage);
                
                if (nearestPlayer.health <= 0) {
                    // í”Œë ˆì´ì–´ ì œê±°
                    gameState.players.delete(nearestPlayer.id);
                    gameState.kills++;
                    showHitMarker(`${nearestPlayer.name} ì œê±°! (+1 í‚¬)`);
                    
                    // ìŠ¹ë¦¬ ì¡°ê±´ í™•ì¸
                    if (gameState.players.size === 0) {
                        endGame('ìŠ¹ë¦¬!', 'ğŸ† ì¶•í•˜í•©ë‹ˆë‹¤! ì¹˜í‚¨ì„ íšë“í–ˆìŠµë‹ˆë‹¤!');
                    }
                } else {
                    showHitMarker(`${nearestPlayer.name} ì ì¤‘! (-${damage}HP)`);
                }
            } else {
                showHitMarker('ë¹—ë‚˜ê°');
            }
        } else {
            showHitMarker('ì‚¬ì •ê±°ë¦¬ ë°–');
        }
    }

    // ëª…ì¤‘ í‘œì‹œ
    function showHitMarker(message) {
        const marker = document.createElement('div');
        marker.style.cssText = `
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #00ff41;
            padding: 10px 20px;
            border-radius: 20px;
            border: 2px solid #00ff41;
            font-size: 16px;
            font-weight: bold;
            z-index: 180;
            pointer-events: none;
            animation: hitMarkerFade 2s ease-out forwards;
        `;
        marker.textContent = message;
        document.body.appendChild(marker);
        
        // ìŠ¤íƒ€ì¼ì‹œíŠ¸ì— ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes hitMarkerFade {
                0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2) translateY(-20px); }
            }
        `;
        document.head.appendChild(style);
        
        setTimeout(() => {
            marker.remove();
            style.remove();
        }, 2000);
    }

    // ì¬ì¥ì „
    function reload() {
        if (gameState.isReloading || gameState.ammo === 30) return;
        
        gameState.isReloading = true;
        showHitMarker('ì¬ì¥ì „ ì¤‘...');
        
        setTimeout(() => {
            gameState.ammo = 30;
            gameState.isReloading = false;
            showHitMarker('ì¬ì¥ì „ ì™„ë£Œ!');
        }, 2000);
    }

    // ê²Œì„ ì¢…ë£Œ
    function endGame(title, message) {
        clearInterval(gameState.gameLoop);
        showStatus(title, message);
    }

    // ê²Œì„ ë‚˜ê°€ê¸°
    function leaveGame() {
        if (gameState.gameLoop) {
            clearInterval(gameState.gameLoop);
        }
        gameState.connections.forEach(conn => conn.close());
        gameState.connections.clear();
        gameState.players.clear();
        showScreen('lobby');
    }

    // ìœ„ì¹˜ ì •ë³´ ë¸Œë¡œë“œìºìŠ¤íŠ¸
    function broadcastPosition() {
        const message = {
            type: 'position',
            data: {
                playerId: gameState.playerName,
                position: gameState.position,
                orientation: gameState.orientation,
                health: gameState.health,
                timestamp: Date.now()
            }
        };
        
        // P2P ì—°ê²°ì„ í†µí•´ ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ì—ê²Œ ì „ì†¡
        gameState.connections.forEach(conn => {
            if (conn.readyState === 'open') {
                try {
                    conn.send(JSON.stringify(message));
                } catch (e) {
                    console.log('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', e);
                }
            }
        });
    }

    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(title, message) {
        document.getElementById('statusTitle').textContent = title;
        document.getElementById('statusMessage').textContent = message;
        document.getElementById('statusOverlay').classList.remove('hidden');
    }

    // ìƒíƒœ ë©”ì‹œì§€ ë‹«ê¸°
    function closeStatus() {
        document.getElementById('statusOverlay').classList.add('hidden');
    }

    // P2P ì—°ê²° ì„¤ì • (ì‹¤ì œ êµ¬í˜„ì‹œ í•„ìš”)
    function createPeerConnection(playerId) {
        const pc = new RTCPeerConnection(rtcConfig);
        
        // ë°ì´í„° ì±„ë„ ìƒì„±
        const dataChannel = pc.createDataChannel('game', {
            ordered: false,
            maxRetransmits: 0
        });
        
        dataChannel.onopen = () => {
            console.log(`${playerId}ì™€ ì—°ê²°ë¨`);
            updateConnectionStatus('connected');
        };
        
        dataChannel.onmessage = (event) => {
            handlePeerMessage(JSON.parse(event.data));
        };
        
        dataChannel.onerror = (error) => {
            console.log('ë°ì´í„° ì±„ë„ ì˜¤ë¥˜:', error);
            updateConnectionStatus('disconnected');
        };
        
        pc.ondatachannel = (event) => {
            const channel = event.channel;
            channel.onmessage = (event) => {
                handlePeerMessage(JSON.parse(event.data));
            };
        };
        
        gameState.connections.set(playerId, dataChannel);
        return pc;
    }

    // í”¼ì–´ ë©”ì‹œì§€ ì²˜ë¦¬
    function handlePeerMessage(message) {
        switch (message.type) {
            case 'position':
                updatePlayerPosition(message.data);
                break;
            case 'shot':
                handlePeerShot(message.data);
                break;
            case 'hit':
                handlePeerHit(message.data);
                break;
        }
    }

    // ë‹¤ë¥¸ í”Œë ˆì´ì–´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    function updatePlayerPosition(data) {
        gameState.players.set(data.playerId, {
            ...gameState.players.get(data.playerId),
            position: data.position,
            orientation: data.orientation,
            health: data.health,
            lastSeen: Date.now()
        });
    }

    // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateConnectionStatus(status) {
        const statusEl = document.getElementById('connectionStatus');
        statusEl.className = `connection-status ${status}`;
        
        switch (status) {
            case 'connected':
                statusEl.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
                break;
            case 'connecting':
                statusEl.textContent = 'ğŸŸ¡ ì—°ê²° ì¤‘...';
                break;
            case 'disconnected':
                statusEl.textContent = 'ğŸ”´ ì—°ê²° ëŠê¹€';
                break;
        }
    }

    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ë°ìŠ¤í¬í†±ì—ì„œ í…ŒìŠ¤íŠ¸ìš©)
    document.addEventListener('keydown', (event) => {
        if (gameState.screen === 'game') {
            switch (event.code) {
                case 'Space':
                    event.preventDefault();
                    startShooting();
                    setTimeout(stopShooting, 100);
                    break;
                case 'KeyR':
                    event.preventDefault();
                    reload();
                    break;
            }
        }
    });

    // ë°©í–¥ ë³€í™” ê°ì§€ (í™”ë©´ íšŒì „ ë°©ì§€)
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            window.scrollTo(0, 1);
        }, 100);
    });

    // í™”ë©´ êº¼ì§ ë°©ì§€ (ê²Œì„ ì¤‘)
    let wakeLock = null;
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
            }
        } catch (err) {
            console.log('í™”ë©´ ìœ ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', err);
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', () => {
        init();
        
        // ê²Œì„ ì‹œì‘ì‹œ í™”ë©´ ìœ ì§€ ìš”ì²­
        document.addEventListener('click', requestWakeLock, { once: true });
    });

    // í˜ì´ì§€ ë²—ì–´ë‚  ë•Œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
        if (wakeLock) {
            wakeLock.release();
        }
        gameState.connections.forEach(conn => conn.close());
    });

    // í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ ê°œì„ 
    let touchStartTime = 0;
    
    document.getElementById('shootButton').addEventListener('touchstart', (e) => {
        e.preventDefault();
        touchStartTime = Date.now();
        startShooting();
    });
    
    document.getElementById('shootButton').addEventListener('touchend', (e) => {
        e.preventDefault();
        stopShooting();
    });

    // ë°© ì½”ë“œ ì…ë ¥ì—ì„œ ì—”í„°í‚¤ ì²˜ë¦¬
    document.getElementById('roomCodeInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            joinRoom();
        }
    });

    // ë°ëª¨ìš© AI ì ë“¤ì˜ ê°„ë‹¨í•œ í–‰ë™
    function simulateAI() {
        if (gameState.screen !== 'game') return;
        
        gameState.players.forEach((player, id) => {
            // ê°€ë” í”Œë ˆì´ì–´ì—ê²Œ í”¼í•´ë¥¼ ì¤Œ (ë°ëª¨ìš©)
            if (Math.random() < 0.001) { // 0.1% í™•ë¥ 
                const distance = calculateDistance(gameState.position, player.position);
                if (distance < 30) { // 30m ì´ë‚´
                    gameState.health = Math.max(0, gameState.health - Math.floor(Math.random() * 20 + 10));
                    showHitEffect();
                    
                    if (gameState.health <= 0) {
                        endGame('íŒ¨ë°°', `${player.name}ì—ê²Œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    }
                }
            }
        });
    }

    // í”¼ê²© íš¨ê³¼
    function showHitEffect() {
        const effect = document.createElement('div');
        effect.className = 'hit-effect';
        document.body.appendChild(effect);
        
        setTimeout(() => {
            effect.remove();
        }, 500);
        
        // ì§„ë™
        if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
        }
    }

    // AI ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
    setInterval(simulateAI, 100);

    // PWA ë§¤ë‹ˆí˜ìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
    const manifest = {
        name: "PUBG AR - ë°°í‹€ë¡œì–„",
        short_name: "PUBG AR",
        description: "ë¡œê·¸ì¸ ì—†ëŠ” P2P ì¦ê°•í˜„ì‹¤ ë°°í‹€ë¡œì–„ ê²Œì„",
        start_url: "/",
        display: "standalone",
        background_color: "#1a1a2e",
        theme_color: "#00ff41",
        orientation: "portrait",
        icons: [
            {
                src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMWExYTJlIi8+Cjx0ZXh0IHg9Ijk2IiB5PSIxMTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI2MCIgZmlsbD0iIzAwZmY0MSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+OvzwvdGV4dD4KPC9zdmc+",
                sizes: "192x192",
                type: "image/svg+xml"
            }
        ]
    };

    // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ (ì˜¤í”„ë¼ì¸ ì§€ì›)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const swCode = `
                const CACHE_NAME = 'pubg-ar-v1';
                const urlsToCache = ['/'];
                
                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then((cache) => cache.addAll(urlsToCache))
                    );
                });
                
                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request)
                            .then((response) => response || fetch(event.request))
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(() => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì™„ë£Œ'))
                .catch(err => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨:', err));
        });
    }
</script>
```

</body>
</html>
