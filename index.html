<!DOCTYPE html>

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUBG AR - P2P Î∞∞ÌãÄÎ°úÏñÑ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Arial', sans-serif;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        color: white;
        overflow: hidden;
        height: 100vh;
        user-select: none;
    }

    .game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .lobby {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        text-align: center;
        padding: 20px;
    }

    .lobby h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 0 0 20px #00ff41;
    }

    .lobby p {
        font-size: 1.1rem;
        opacity: 0.8;
        margin-bottom: 30px;
    }

    .name-display {
        font-size: 1.3rem;
        color: #00ff41;
        margin: 20px 0;
        padding: 15px;
        background: rgba(0, 255, 65, 0.1);
        border: 2px solid #00ff41;
        border-radius: 10px;
        min-width: 200px;
    }

    .room-code-display {
        font-size: 1.1rem;
        color: #ffaa00;
        margin: 15px 0;
        padding: 10px;
        background: rgba(255, 170, 0, 0.1);
        border: 2px solid #ffaa00;
        border-radius: 8px;
    }

    .btn-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }

    .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        min-width: 200px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        border: 2px solid #ff4444;
    }

    .btn-secondary {
        background: linear-gradient(135deg, #4ecdc4, #44a08d);
        color: white;
        border: 2px solid #00ff41;
    }

    .btn-info {
        background: linear-gradient(135deg, #ffa726, #ffcc02);
        color: #333;
        border: 2px solid #ffaa00;
    }

    .btn:active {
        transform: scale(0.95);
    }

    .btn:hover {
        filter: brightness(1.1);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .game-screen {
        flex: 1;
        position: relative;
        background: radial-gradient(circle at center, #0f3460, #16537e, #1a1a2e);
    }

    .hud {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .hud-panel {
        background: rgba(0, 0, 0, 0.8);
        padding: 12px;
        border-radius: 10px;
        border: 2px solid #00ff41;
        backdrop-filter: blur(5px);
    }

    .health-bar {
        width: 120px;
        height: 8px;
        background: #333;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
    }

    .health-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff41);
        transition: width 0.5s;
    }

    .crosshair {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        z-index: 50;
        pointer-events: none;
    }

    .crosshair::before,
    .crosshair::after {
        content: '';
        position: absolute;
        background: #00ff41;
        box-shadow: 0 0 15px #00ff41;
        border-radius: 2px;
    }

    .crosshair::before {
        width: 3px;
        height: 25px;
        top: 12px;
        left: 23px;
    }

    .crosshair::after {
        width: 25px;
        height: 3px;
        top: 23px;
        left: 12px;
    }

    .controls {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 100;
    }

    .shoot-btn {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: radial-gradient(circle, #ff4444, #aa0000);
        border: 3px solid #ff6666;
        color: white;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.1s;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
    }

    .shoot-btn:active {
        transform: scale(0.9);
        box-shadow: 0 0 30px rgba(255, 68, 68, 0.8);
    }

    .player-radar {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 100px;
        height: 100px;
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #00ff41;
        border-radius: 50%;
        z-index: 90;
    }

    .player-list {
        position: absolute;
        top: 140px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 10px;
        border: 2px solid #00ff41;
        max-height: 200px;
        min-width: 180px;
        overflow-y: auto;
    }

    .player-item {
        padding: 8px 0;
        border-bottom: 1px solid #333;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
    }

    .player-item:last-child {
        border-bottom: none;
    }

    .distance-display {
        position: absolute;
        bottom: 140px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 12px 20px;
        border-radius: 20px;
        border: 2px solid #00ff41;
        font-size: 18px;
        font-weight: bold;
    }

    .status-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 200;
    }

    .status-modal {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        padding: 30px;
        border-radius: 15px;
        border: 3px solid #00ff41;
        text-align: center;
        max-width: 300px;
        width: 90%;
    }

    .status-modal h3 {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: #00ff41;
    }

    .hidden {
        display: none !important;
    }

    .hit-effect {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: radial-gradient(circle, rgba(255, 0, 0, 0.3), transparent);
        pointer-events: none;
        animation: hitFlash 0.5s ease-out;
        z-index: 150;
    }

    @keyframes hitFlash {
        0% { opacity: 0; }
        50% { opacity: 1; }
        100% { opacity: 0; }
    }

    .connection-status {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 15px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 20px;
        font-size: 12px;
        z-index: 110;
    }

    .connected { border: 2px solid #00ff41; color: #00ff41; }
    .connecting { border: 2px solid #ffaa00; color: #ffaa00; }
    .disconnected { border: 2px solid #ff4444; color: #ff4444; }

    .radar-dot {
        position: absolute;
        width: 6px;
        height: 6px;
        background: #ff4444;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 8px #ff4444;
    }

    .ping-display {
        position: absolute;
        bottom: 10px;
        right: 10px;
        padding: 5px 10px;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #00ff41;
        border-radius: 5px;
        font-size: 12px;
    }

    @keyframes hitMarkerFade {
        0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2) translateY(-20px); }
    }

    @media (max-width: 480px) {
        .lobby h1 { font-size: 2rem; }
        .btn { font-size: 14px; padding: 12px 25px; }
        .hud { left: 10px; right: 10px; top: 10px; }
        .controls { bottom: 20px; }
    }
</style>
```

</head>
<body>
    <div class="game-container">
        <!-- Î°úÎπÑ ÌôîÎ©¥ -->
        <div id="lobbyScreen" class="lobby">
            <h1>üéØ PUBG AR</h1>
            <p>Ïã§ÏãúÍ∞Ñ P2P Î∞∞ÌãÄÎ°úÏñÑ</p>

```
        <div class="name-display">
            <div>üéÆ <span id="playerNameDisplay"></span></div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="createRoom()">
                üè† Î∞© ÎßåÎì§Í∏∞
            </button>
            <button class="btn btn-secondary" onclick="showJoinRoom()">
                üö™ Î∞© Ï∞∏Í∞ÄÌïòÍ∏∞
            </button>
            <button class="btn btn-info" onclick="generateNewName()">
                üé≤ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω
            </button>
        </div>
        
        <div style="margin-top: 30px; font-size: 13px; opacity: 0.7; line-height: 1.4;">
            <p>üì± Ïä§ÎßàÌä∏Ìè∞ÏùÑ Ï¥ùÏ≤òÎüº Îì§Í≥† Ï°∞Ï§Ä</p>
            <p>üéØ Îπ®Í∞Ñ Î≤ÑÌäºÏúºÎ°ú Î∞úÏÇ¨!</p>
            <p>‚ö° Ïã§ÏãúÍ∞Ñ Î©ÄÌã∞ÌîåÎ†àÏù¥</p>
        </div>
    </div>

    <!-- Î∞© Ï∞∏Í∞Ä ÌôîÎ©¥ -->
    <div id="joinRoomScreen" class="lobby hidden">
        <h2>üö™ Î∞© Ï∞∏Í∞Ä</h2>
        <p>ÏπúÍµ¨Í∞Ä Ï§Ä Î∞© ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
        
        <div style="margin: 30px 0;">
            <input type="text" id="roomCodeInput" 
                   style="padding: 15px; font-size: 18px; border: 2px solid #00ff41; border-radius: 8px; background: rgba(0,0,0,0.7); color: white; text-align: center; width: 200px;"
                   placeholder="Î∞© ÏΩîÎìú ÏûÖÎ†•" maxlength="6">
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="joinRoom()">
                ‚úÖ Ï∞∏Í∞ÄÌïòÍ∏∞
            </button>
            <button class="btn btn-secondary" onclick="backToLobby()">
                ‚Üê Îí§Î°úÍ∞ÄÍ∏∞
            </button>
        </div>
    </div>

    <!-- Î∞© ÎåÄÍ∏∞ ÌôîÎ©¥ -->
    <div id="waitingScreen" class="lobby hidden">
        <h2>üè† Î∞© ÎåÄÍ∏∞Ïã§</h2>
        <div class="room-code-display">
            Î∞© ÏΩîÎìú: <strong id="roomCodeDisplay"></strong>
        </div>
        <p>ÏπúÍµ¨Îì§ÏóêÍ≤å ÏúÑ ÏΩîÎìúÎ•º ÏïåÎ†§Ï£ºÏÑ∏Ïöî!</p>
        
        <div id="waitingPlayers" style="margin: 30px 0;">
            <h3>Ï∞∏Í∞ÄÏûê Î™©Î°ù</h3>
            <div id="playersList"></div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="startGame()" id="startGameBtn" disabled>
                üöÄ Í≤åÏûÑ ÏãúÏûë (2Î™Ö Ïù¥ÏÉÅ)
            </button>
            <button class="btn btn-secondary" onclick="leaveRoom()">
                üö™ Î∞© ÎÇòÍ∞ÄÍ∏∞
            </button>
        </div>
    </div>

    <!-- Í≤åÏûÑ ÌôîÎ©¥ -->
    <div id="gameScreen" class="game-screen hidden">
        <div class="connection-status connecting" id="connectionStatus">
            Ïó∞Í≤∞ Ï§ë...
        </div>
        
        <div class="hud">
            <div class="hud-panel">
                <div>‚ù§Ô∏è <span id="healthDisplay">100</span>/100</div>
                <div class="health-bar">
                    <div class="health-fill" id="healthBar" style="width: 100%;"></div>
                </div>
                <div>üèÜ ÌÇ¨: <span id="killDisplay">0</span></div>
                <div>üìã ÌÉÑÏïΩ: <span id="ammoDisplay">30</span>/30</div>
            </div>
            
            <div class="hud-panel">
                <div>üë• ÏÉùÏ°¥: <span id="aliveDisplay">0</span></div>
                <div>üì° Í±∞Î¶¨: <span id="nearestDistance">-</span>m</div>
                <div>üîó Ïó∞Í≤∞: <span id="connectedCount">0</span></div>
            </div>
        </div>

        <div class="crosshair"></div>
        
        <div class="player-radar" id="radar">
            <!-- Î†àÏù¥Îçî Ï†êÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
        </div>

        <div class="player-list">
            <h4 style="margin-bottom: 10px;">ÌîåÎ†àÏù¥Ïñ¥</h4>
            <div id="gamePlayersList"></div>
        </div>

        <div class="distance-display" id="distanceInfo">
            Ï°∞Ï§Ä Ï§ë: <span id="targetName">-</span>
        </div>

        <div class="ping-display" id="pingDisplay">
            Ìïë: <span id="pingValue">-</span>ms
        </div>

        <div class="controls">
            <button class="btn btn-secondary" onclick="leaveGame()" style="font-size: 12px; padding: 8px 15px;">
                üö™ ÎÇòÍ∞ÄÍ∏∞
            </button>
            
            <button class="shoot-btn" id="shootButton" 
                    onmousedown="startShooting()" onmouseup="stopShooting()"
                    ontouchstart="startShooting(event)" ontouchend="stopShooting(event)">
                üî´
            </button>
            
            <button class="btn btn-secondary" onclick="reload()" style="font-size: 12px; padding: 8px 15px;">
                üîÑ Ïû¨Ïû•Ï†Ñ
            </button>
        </div>
    </div>

    <!-- ÏÉÅÌÉú Î©îÏãúÏßÄ Î™®Îã¨ -->
    <div id="statusOverlay" class="status-overlay hidden">
        <div class="status-modal">
            <h3 id="statusTitle"></h3>
            <p id="statusMessage"></p>
            <button class="btn btn-primary" onclick="closeStatus()" style="margin-top: 15px;">
                ÌôïÏù∏
            </button>
        </div>
    </div>
</div>

<script>
    // Í≤åÏûÑ ÏÉÅÌÉú Í¥ÄÎ¶¨
    let gameState = {
        screen: 'lobby',
        playerId: '',
        playerName: '',
        roomCode: '',
        isHost: false,
        health: 100,
        kills: 0,
        ammo: 30,
        maxAmmo: 30,
        isReloading: false,
        position: { lat: 0, lng: 0, accuracy: 0 },
        orientation: { alpha: 0, beta: 0, gamma: 0 },
        players: new Map(),
        connections: new Map(),
        lastShot: 0,
        gameStartTime: 0,
        signaling: null,
        gameLoop: null,
        pingInterval: null
    };

    // WebSocket ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ (Î¨¥Î£å WebSocket ÏÑúÎπÑÏä§ ÏÇ¨Ïö©)
    const SIGNALING_SERVER = 'wss://ws.postman-echo.com/raw';

    // ICE ÏÑúÎ≤Ñ ÏÑ§Ï†ï (Î¨¥Î£å STUN ÏÑúÎ≤Ñ)
    const rtcConfig = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun.services.mozilla.com' },
            { urls: 'stun:stun.stunprotocol.org:3478' }
        ]
    };

    // ÎûúÎç§ ÎãâÎÑ§ÏûÑ ÏÉùÏÑ±
    const adjectives = ['Ïö©Í∞êÌïú', 'Îπ†Î•∏', 'Í∞ïÎ†•Ìïú', 'ÎòëÎòëÌïú', 'Ïã†ÎπÑÌïú', 'Ï∞®Í∞ÄÏö¥', 'Îú®Í±∞Ïö¥', 'ÎÇ†Ïπ¥Î°úÏö¥', 'Ï°∞Ïö©Ìïú', 'Í±∞ÎåÄÌïú'];
    const nouns = ['Ï†ÑÏÇ¨', 'ÏÇ¨ÎÉ•Íæº', 'Ï†ÄÍ≤©Ïàò', 'ÌäπÍ≥µÎåÄ', 'Ïö©Î≥ë', 'ÎãåÏûê', 'Ìï¥Ï†Å', 'Í∏∞ÏÇ¨', 'ÎßàÎ≤ïÏÇ¨', 'Î°úÎ¥á'];

    function generateRandomName() {
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const noun = nouns[Math.floor(Math.random() * nouns.length)];
        const num = Math.floor(Math.random() * 1000);
        return `${adj}${noun}${num}`;
    }

    // Í≥†Ïú† ÌîåÎ†àÏù¥Ïñ¥ ID ÏÉùÏÑ±
    function generatePlayerId() {
        return Math.random().toString(36).substring(2, 15) + Date.now().toString(36);
    }

    // Ï¥àÍ∏∞Ìôî
    function init() {
        gameState.playerId = generatePlayerId();
        gameState.playerName = generateRandomName();
        document.getElementById('playerNameDisplay').textContent = gameState.playerName;
        
        // ÏúÑÏπò Ï†ïÎ≥¥ Í∂åÌïú ÏöîÏ≤≠
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(updatePosition, handleLocationError, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            });
        } else {
            handleLocationError({ message: 'ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§' });
        }
        
        // ÎîîÎ∞îÏù¥Ïä§ Î∞©Ìñ• Í∂åÌïú ÏöîÏ≤≠
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission().then(response => {
                if (response === 'granted') {
                    window.addEventListener('deviceorientation', updateOrientation);
                }
            });
        } else {
            window.addEventListener('deviceorientation', updateOrientation);
        }
        
        // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ (Í≤åÏûÑ Ï§ë Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ)
        document.addEventListener('touchmove', function(e) {
            if (gameState.screen === 'game') {
                e.preventDefault();
            }
        }, { passive: false });

        // ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ Ïó∞Í≤∞ (Î∞©Ïù¥ ÏûàÏùÑ ÎïåÎßå)
        // connectSignaling();
    }

    // ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ Ïó∞Í≤∞
    function connectSignaling() {
        try {
            // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî Ï†ÅÏ†àÌïú WebSocket ÏÑúÎ≤ÑÎ•º ÏÇ¨Ïö©Ìï¥Ïïº Ìï©ÎãàÎã§
            // Ïó¨Í∏∞ÏÑúÎäî Firebase Realtime DatabaseÎÇò Socket.io ÏÑúÎ≤ÑÎ•º Í∂åÏû•Ìï©ÎãàÎã§
            gameState.signaling = new WebSocket('wss://echo.websocket.org');
            
            gameState.signaling.onopen = () => {
                console.log('ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®');
                updateConnectionStatus('connected');
            };

            gameState.signaling.onmessage = (event) => {
                handleSignalingMessage(JSON.parse(event.data));
            };

            gameState.signaling.onerror = (error) => {
                console.error('ÏãúÍ∑∏ÎÑêÎßÅ Ïò§Î•ò:', error);
                updateConnectionStatus('disconnected');
            };

            gameState.signaling.onclose = () => {
                console.log('ÏãúÍ∑∏ÎÑêÎßÅ Ïó∞Í≤∞ Ï¢ÖÎ£å');
                updateConnectionStatus('disconnected');
                
                // Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ
                setTimeout(connectSignaling, 3000);
            };

        } catch (error) {
            console.error('ÏãúÍ∑∏ÎÑêÎßÅ Ïó∞Í≤∞ Ïã§Ìå®:', error);
            // Îç∞Î™®Ïö©ÏúºÎ°ú Î°úÏª¨ Ïó∞Í≤∞ ÏãúÎÆ¨Î†àÏù¥ÏÖò
            simulateLocalConnection();
        }
    }

    // Î°úÏª¨ Ïó∞Í≤∞ ÏãúÎÆ¨Î†àÏù¥ÏÖò (ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ ÏóÜÏù¥ ÌÖåÏä§Ìä∏Ïö©)
    function simulateLocalConnection() {
        setTimeout(() => {
            updateConnectionStatus('connected');
        }, 1000);
    }

    // ÏãúÍ∑∏ÎÑêÎßÅ Î©îÏãúÏßÄ Ï≤òÎ¶¨
    function handleSignalingMessage(message) {
        console.log('ÏãúÍ∑∏ÎÑêÎßÅ Î©îÏãúÏßÄ:', message);
        
        if (message.roomCode !== gameState.roomCode) return;

        switch (message.type) {
            case 'join-room':
                handlePlayerJoin(message);
                break;
            case 'offer':
                handleOffer(message);
                break;
            case 'answer':
                handleAnswer(message);
                break;
            case 'ice-candidate':
                handleIceCandidate(message);
                break;
            case 'leave-room':
                handlePlayerLeave(message);
                break;
            case 'start-game':
                handleGameStart(message);
                break;
        }
    }

    function updatePosition(position) {
        gameState.position = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy
        };
        broadcastPosition();
    }

    function handleLocationError(error) {
        console.log('ÏúÑÏπò Ï†ïÎ≥¥ Ïò§Î•ò:', error.message);
        // ÏÑúÏö∏ Ï§ëÏã¨Î∂Ä Í∑ºÏ≤òÏùò ÎûúÎç§ ÏúÑÏπò ÏÉùÏÑ± (ÌÖåÏä§Ìä∏Ïö©)
        gameState.position = {
            lat: 37.5665 + (Math.random() - 0.5) * 0.01,
            lng: 126.9780 + (Math.random() - 0.5) * 0.01,
            accuracy: 10
        };
    }

    function updateOrientation(event) {
        gameState.orientation = {
            alpha: event.alpha || 0,
            beta: event.beta || 0,
            gamma: event.gamma || 0
        };
    }

    // ÌôîÎ©¥ Ï†ÑÌôò
    function showScreen(screenName) {
        document.querySelectorAll('.lobby, .game-screen').forEach(el => el.classList.add('hidden'));
        
        switch(screenName) {
            case 'lobby':
                document.getElementById('lobbyScreen').classList.remove('hidden');
                break;
            case 'joinRoom':
                document.getElementById('joinRoomScreen').classList.remove('hidden');
                break;
            case 'waiting':
                document.getElementById('waitingScreen').classList.remove('hidden');
                break;
            case 'game':
                document.getElementById('gameScreen').classList.remove('hidden');
                break;
        }
        
        gameState.screen = screenName;
    }

    // ÎãâÎÑ§ÏûÑ Ïû¨ÏÉùÏÑ±
    function generateNewName() {
        gameState.playerName = generateRandomName();
        document.getElementById('playerNameDisplay').textContent = gameState.playerName;
    }

    // Î∞© ÎßåÎì§Í∏∞
    function createRoom() {
        gameState.roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        gameState.isHost = true;
        
        document.getElementById('roomCodeDisplay').textContent = gameState.roomCode;
        showScreen('waiting');
        
        // ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ Ïó∞Í≤∞
        connectSignaling();
        
        // Î∞©Ïû•ÏùÄ ÏûêÏã†ÏùÑ ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ùÏóê Ï∂îÍ∞Ä
        const hostPlayer = {
            id: gameState.playerId,
            name: gameState.playerName,
            isHost: true
        };
        updatePlayersList([hostPlayer]);

        // Î∞© Ï†ïÎ≥¥Î•º ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤ÑÏóê Ï†ÑÏÜ°
        setTimeout(() => {
            sendSignalingMessage({
                type: 'create-room',
                roomCode: gameState.roomCode,
                playerId: gameState.playerId,
                playerName: gameState.playerName
            });
        }, 1000);
    }

    // Î∞© Ï∞∏Í∞Ä ÌôîÎ©¥ ÌëúÏãú
    function showJoinRoom() {
        showScreen('joinRoom');
        document.getElementById('roomCodeInput').focus();
    }

    // Î∞© Ï∞∏Í∞Ä
    function joinRoom() {
        const roomCode = document.getElementById('roomCodeInput').value.toUpperCase();
        if (roomCode.length !== 6) {
            showStatus('Ïò§Î•ò', 'Î∞© ÏΩîÎìúÎäî 6ÏûêÎ¶¨Ïó¨Ïïº Ìï©ÎãàÎã§.');
            return;
        }
        
        gameState.roomCode = roomCode;
        gameState.isHost = false;
        
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        showScreen('waiting');
        
        // ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ Ïó∞Í≤∞
        connectSignaling();
        
        // Î∞© Ï∞∏Í∞Ä ÏöîÏ≤≠
        setTimeout(() => {
            sendSignalingMessage({
                type: 'join-room',
                roomCode: gameState.roomCode,
                playerId: gameState.playerId,
                playerName: gameState.playerName
            });
        }, 1000);

        // Îç∞Î™®Ïö© ÌîåÎ†àÏù¥Ïñ¥ Ï∂îÍ∞Ä
        setTimeout(() => {
            updatePlayersList([
                { id: 'host', name: 'Î∞©Ïû•', isHost: true },
                { id: gameState.playerId, name: gameState.playerName, isHost: false }
            ]);
        }, 2000);
    }

    // ÏãúÍ∑∏ÎÑêÎßÅ Î©îÏãúÏßÄ Ï†ÑÏÜ°
    function sendSignalingMessage(message) {
        if (gameState.signaling && gameState.signaling.readyState === WebSocket.OPEN) {
            gameState.signaling.send(JSON.stringify(message));
        } else {
            console.log('ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå, Î©îÏãúÏßÄ Î¨¥Ïãú:', message);
        }
    }

    // WebRTC Ïó∞Í≤∞ ÏÉùÏÑ±
    function createPeerConnection(peerId) {
        const peerConnection = new RTCPeerConnection(rtcConfig);
        
        // Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê ÏÉùÏÑ±
        const dataChannel = peerConnection.createDataChannel('game', {
            ordered: false,
            maxRetransmits: 3
        });
        
        dataChannel.onopen = () => {
            console.log(`${peerId}ÏôÄ Ïó∞Í≤∞Îê®`);
            updateConnectionStatus('connected');
            updateConnectedCount();
        };
        
        dataChannel.onclose = () => {
            console.log(`${peerId} Ïó∞Í≤∞ ÎÅäÏñ¥Ïßê`);
            gameState.players.delete(peerId);
            updateConnectedCount();
            updateGameUI();
        };
        
        dataChannel.onmessage = (event) => {
            handlePeerMessage(JSON.parse(event.data), peerId);
        };
        
        dataChannel.onerror = (error) => {
            console.error(`${peerId} Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê Ïò§Î•ò:`, error);
            updateConnectionStatus('disconnected');
        };
        
        // ICE ÌõÑÎ≥¥ Ï≤òÎ¶¨
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                sendSignalingMessage({
                    type: 'ice-candidate',
                    roomCode: gameState.roomCode,
                    targetId: peerId,
                    senderId: gameState.playerId,
                    candidate: event.candidate
                });
            }
        };
        
        // ÏõêÍ≤© Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê Ï≤òÎ¶¨
        peerConnection.ondatachannel = (event) => {
            const channel = event.channel;
            channel.onmessage = (event) => {
                handlePeerMessage(JSON.parse(event.data), peerId);
            };
            channel.onopen = () => {
                console.log(`${peerId}Î°úÎ∂ÄÌÑ∞ Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê Ïó∞Í≤∞Îê®`);
                updateConnectedCount();
            };
        };
        
        gameState.connections.set(peerId, { peerConnection, dataChannel });
        return peerConnection;
    }

    // ÌîºÏñ¥ Î©îÏãúÏßÄ Ï≤òÎ¶¨
    function handlePeerMessage(message, peerId) {
        const now = Date.now();
        
        switch (message.type) {
            case 'position':
                updatePlayerPosition(message.data, peerId);
                break;
            case 'shot':
                handlePeerShot(message.data, peerId);
                break;
            case 'hit':
                handlePeerHit(message.data);
                break;
            case 'death':
                handlePlayerDeath(message.data, peerId);
                break;
            case 'ping':
                sendPeerMessage(peerId, {
                    type: 'pong',
                    timestamp: message.timestamp
                });
                break;
            case 'pong':
                updatePing(now - message.timestamp);
                break;
        }
    }

    // ÌîºÏñ¥ÏóêÍ≤å Î©îÏãúÏßÄ Ï†ÑÏÜ°
    function sendPeerMessage(peerId, message) {
        const connection = gameState.connections.get(peerId);
        if (connection && connection.dataChannel && connection.dataChannel.readyState === 'open') {
            try {
                connection.dataChannel.send(JSON.stringify(message));
            } catch (error) {
                console.error(`${peerId}ÏóêÍ≤å Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:`, error);
            }
        }
    }

    // Î™®Îì† ÌîºÏñ¥ÏóêÍ≤å Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
    function broadcastMessage(message) {
        gameState.connections.forEach((connection, peerId) => {
            sendPeerMessage(peerId, message);
        });
    }

    // ÌîåÎ†àÏù¥Ïñ¥ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
    function updatePlayerPosition(data, peerId) {
        const existingPlayer = gameState.players.get(peerId) || {};
        gameState.players.set(peerId, {
            ...existingPlayer,
            id: peerId,
            name: data.playerName || existingPlayer.name || 'Ïïå Ïàò ÏóÜÏùå',
            position: data.position,
            orientation: data.orientation,
            health: data.health !== undefined ? data.health : existingPlayer.health || 100,
            lastSeen: Date.now()
        });
    }

    // ÏúÑÏπò Ï†ïÎ≥¥ Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
    function broadcastPosition() {
        if (gameState.screen === 'game') {
            broadcastMessage({
                type: 'position',
                data: {
                    playerName: gameState.playerName,
                    position: gameState.position,
                    orientation: gameState.orientation,
                    health: gameState.health,
                    timestamp: Date.now()
                }
            });
        }
    }

    // Î°úÎπÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
    function backToLobby() {
        showScreen('lobby');
    }

    // Î∞© ÎÇòÍ∞ÄÍ∏∞
    function leaveRoom() {
        // P2P Ïó∞Í≤∞ Ï†ïÎ¶¨
        gameState.connections.forEach((connection, peerId) => {
            if (connection.peerConnection) {
                connection.peerConnection.close();
            }
        });
        gameState.connections.clear();
        gameState.players.clear();
        
        // ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤ÑÏóê ÎÇòÍ∞ÄÍ∏∞ ÏïåÎ¶º
        sendSignalingMessage({
            type: 'leave-room',
            roomCode: gameState.roomCode,
            playerId: gameState.playerId
        });
        
        // ÏãúÍ∑∏ÎÑêÎßÅ Ïó∞Í≤∞ Ï¢ÖÎ£å
        if (gameState.signaling) {
            gameState.signaling.close();
            gameState.signaling = null;
        }
        
        showScreen('lobby');
    }

    // ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
    function updatePlayersList(players) {
        const container = document.getElementById('playersList');
        container.innerHTML = '';
        
        players.forEach(player => {
            const playerDiv = document.createElement('div');
            playerDiv.style.cssText = 'padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 5px; display: flex; justify-content: space-between; align-items: center;';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = player.name;
            
            const statusSpan = document.createElement('span');
            statusSpan.textContent = player.isHost ? 'üëë' : 'üéÆ';
            statusSpan.style.fontSize = '16px';
            
            playerDiv.appendChild(nameSpan);
            playerDiv.appendChild(statusSpan);
            container.appendChild(playerDiv);
        });
        
        // ÏãúÏûë Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
        const startBtn = document.getElementById('startGameBtn');
        if (players.length >= 2 && gameState.isHost) {
            startBtn.disabled = false;
            startBtn.style.opacity = '1';
        } else {
            startBtn.disabled = true;
            startBtn.style.opacity = '0.5';
        }
    }

    // Í≤åÏûÑ ÏãúÏûë
    function startGame() {
        if (gameState.screen !== 'waiting' || !gameState.isHost) return;
        
        // Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤å Í≤åÏûÑ ÏãúÏûë ÏïåÎ¶º
        sendSignalingMessage({
            type: 'start-game',
            roomCode: gameState.roomCode,
            playerId: gameState.playerId
        });
        
        // Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
        initializeGame();
    }

    // Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
    function initializeGame() {
        gameState.gameStartTime = Date.now();
        gameState.health = 100;
        gameState.kills = 0;
        gameState.ammo = gameState.maxAmmo;
        gameState.isReloading = false;
        
        showScreen('game');
        updateGameUI();
        startGameLoop();
        startPingCheck();
    }

    // Í≤åÏûÑ Î£®ÌîÑ ÏãúÏûë
    function startGameLoop() {
        gameState.gameLoop = setInterval(() => {
            updateGameUI();
            updateRadar();
            broadcastPosition();
            
            // Ïò§ÎûòÎêú ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ¶¨ (30Ï¥à Ïù¥ÏÉÅ ÏùëÎãµ ÏóÜÏùå)
            const now = Date.now();
            gameState.players.forEach((player, playerId) => {
                if (now - player.lastSeen > 30000) {
                    gameState.players.delete(playerId);
                    const connection = gameState.connections.get(playerId);
                    if (connection) {
                        connection.peerConnection.close();
                        gameState.connections.delete(playerId);
                    }
                }
            });
            
            updateConnectedCount();
            
        }, 1000);
    }

    // Ìïë Ï≤¥ÌÅ¨ ÏãúÏûë
    function startPingCheck() {
        gameState.pingInterval = setInterval(() => {
            gameState.connections.forEach((connection, peerId) => {
                if (connection.dataChannel && connection.dataChannel.readyState === 'open') {
                    sendPeerMessage(peerId, {
                        type: 'ping',
                        timestamp: Date.now()
                    });
                }
            });
        }, 5000);
    }

    // Ìïë ÏóÖÎç∞Ïù¥Ìä∏
    function updatePing(pingTime) {
        document.getElementById('pingValue').textContent = Math.round(pingTime);
    }

    // Ïó∞Í≤∞Îêú ÌîåÎ†àÏù¥Ïñ¥ Ïàò ÏóÖÎç∞Ïù¥Ìä∏
    function updateConnectedCount() {
        let connectedCount = 0;
        gameState.connections.forEach(connection => {
            if (connection.dataChannel && connection.dataChannel.readyState === 'open') {
                connectedCount++;
            }
        });
        document.getElementById('connectedCount').textContent = connectedCount;
    }

    // Í≤åÏûÑ UI ÏóÖÎç∞Ïù¥Ìä∏
    function updateGameUI() {
        document.getElementById('healthDisplay').textContent = gameState.health;
        document.getElementById('healthBar').style.width = gameState.health + '%';
        document.getElementById('killDisplay').textContent = gameState.kills;
        document.getElementById('aliveDisplay').textContent = gameState.players.size + 1;
        document.getElementById('ammoDisplay').textContent = gameState.ammo;
        
        // ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        const gamePlayersList = document.getElementById('gamePlayersList');
        gamePlayersList.innerHTML = '';
        
        let nearestDistance = Infinity;
        let nearestPlayer = null;
        
        gameState.players.forEach(player => {
            const distance = calculateDistance(gameState.position, player.position);
            
            if (distance < nearestDistance && player.health > 0) {
                nearestDistance = distance;
                nearestPlayer = player;
            }
            
            const playerItem = document.createElement('div');
            playerItem.className = 'player-item';
            
            const healthColor = player.health > 50 ? '#00ff41' : player.health > 20 ? '#ffaa00' : '#ff4444';
            
            playerItem.innerHTML = `
                <span style="color: ${player.health > 0 ? 'white' : '#666'}">
                    ${player.name} ${player.health <= 0 ? 'üíÄ' : ''}
                </span>
                <span style="color: ${healthColor}">
                    ${player.health > 0 ? Math.round(distance) + 'm' : 'ÏÇ¨Îßù'}
                </span>
            `;
            gamePlayersList.appendChild(playerItem);
        });
        
        if (nearestPlayer && nearestDistance < Infinity) {
            document.getElementById('nearestDistance').textContent = Math.round(nearestDistance);
            document.getElementById('targetName').textContent = nearestPlayer.name;
        } else {
            document.getElementById('nearestDistance').textContent = '-';
            document.getElementById('targetName').textContent = '-';
        }

        // ÏäπÎ¶¨ Ï°∞Í±¥ ÌôïÏù∏
        const alivePlayers = Array.from(gameState.players.values()).filter(p => p.health > 0).length;
        if (alivePlayers === 0 && gameState.health > 0) {
            endGame('ÏäπÎ¶¨!', 'üèÜ Ï∂ïÌïòÌï©ÎãàÎã§! ÏπòÌÇ®ÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!');
        }
    }

    // Í±∞Î¶¨ Í≥ÑÏÇ∞ (ÌïòÎ≤ÑÏÇ¨Ïù∏ Í≥µÏãù)
    function calculateDistance(pos1, pos2) {
        const R = 6371000; // ÏßÄÍµ¨ Î∞òÏßÄÎ¶Ñ (ÎØ∏ÌÑ∞)
        const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
        const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Î†àÏù¥Îçî ÏóÖÎç∞Ïù¥Ìä∏
    function updateRadar() {
        const radar = document.getElementById('radar');
        const dots = radar.querySelectorAll('.radar-dot');
        dots.forEach(dot => dot.remove());
        
        gameState.players.forEach(player => {
            if (player.health <= 0) return; // ÏÇ¨ÎßùÌïú ÌîåÎ†àÏù¥Ïñ¥Îäî ÌëúÏãúÌïòÏßÄ ÏïäÏùå
            
            const distance = calculateDistance(gameState.position, player.position);
            if (distance < 200) { // 200m Ïù¥ÎÇ¥Îßå ÌëúÏãú
                const dot = document.createElement('div');
                dot.className = 'radar-dot';
                
                // Î∞©Ìñ• Í≥ÑÏÇ∞
                const bearing = calculateBearing(gameState.position, player.position);
                const radarDistance = Math.min(distance / 200 * 40, 40); // Î†àÏù¥Îçî Î∞òÏßÄÎ¶ÑÏùò 40% ÎÇ¥ÏóêÏÑú ÌëúÏãú
                
                const x = 50 + radarDistance * Math.cos((bearing - 90) * Math.PI / 180);
                const y = 50 + radarDistance * Math.sin((bearing - 90) * Math.PI / 180);
                
                dot.style.left = x + '%';
                dot.style.top = y + '%';
                
                // Í±∞Î¶¨Ïóê Îî∞Îùº ÏÉâÏÉÅ Ï°∞Ï†ï
                const intensity = 1 - (distance / 200);
                dot.style.background = `rgba(255, 68, 68, ${intensity})`;
                dot.style.boxShadow = `0 0 ${8 * intensity}px rgba(255, 68, 68, ${intensity})`;
                
                radar.appendChild(dot);
            }
        });
    }

    // Î∞©ÏúÑÍ∞Å Í≥ÑÏÇ∞
    function calculateBearing(pos1, pos2) {
        const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
        const lat1 = pos1.lat * Math.PI / 180;
        const lat2 = pos2.lat * Math.PI / 180;
        
        const y = Math.sin(dLon) * Math.cos(lat2);
        const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
        
        const bearing = Math.atan2(y, x) * 180 / Math.PI;
        return (bearing + 360) % 360;
    }

    // Î∞úÏÇ¨ ÏãúÏûë
    function startShooting(event) {
        if (event) event.preventDefault();
        
        if (gameState.screen !== 'game' || gameState.ammo <= 0 || gameState.isReloading || gameState.health <= 0) {
            return;
        }
        
        const now = Date.now();
        if (now - gameState.lastShot < 200) { // Î∞úÏÇ¨ ÏÜçÎèÑ Ï†úÌïú (200ms)
            return;
        }
        
        gameState.lastShot = now;
        gameState.ammo--;
        
        // Î∞úÏÇ¨ Ìö®Í≥º
        const shootBtn = document.getElementById('shootButton');
        shootBtn.style.transform = 'scale(0.9)';
        shootBtn.style.boxShadow = '0 0 30px rgba(255, 68, 68, 1)';
        
        // ÏßÑÎèô Ìö®Í≥º
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
        
        // Î™ÖÏ§ë ÌåêÏ†ï
        const hitResult = checkHit();
        
        // Î∞úÏÇ¨ Ï†ïÎ≥¥Î•º Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥Îì§ÏóêÍ≤å Ï†ÑÏÜ°
        broadcastMessage({
            type: 'shot',
            data: {
                shooterId: gameState.playerId,
                shooterName: gameState.playerName,
                position: gameState.position,
                orientation: gameState.orientation,
                timestamp: now,
                hitResult: hitResult
            }
        });
        
        updateGameUI();
        
        // ÌÉÑÏïΩ Î∂ÄÏ°± Ïãú ÏûêÎèô Ïû¨Ïû•Ï†Ñ
        if (gameState.ammo <= 0) {
            setTimeout(reload, 500);
        }
    }

    // Î∞úÏÇ¨ Ï¢ÖÎ£å
    function stopShooting(event) {
        if (event) event.preventDefault();
        
        const shootBtn = document.getElementById('shootButton');
        shootBtn.style.transform = 'scale(1)';
        shootBtn.style.boxShadow = '0 0 20px rgba(255, 68, 68, 0.5)';
    }

    // Î™ÖÏ§ë ÌåêÏ†ï
    function checkHit() {
        let nearestPlayer = null;
        let nearestDistance = Infinity;
        
        // ÏÇ¥ÏïÑÏûàÎäî ÌîåÎ†àÏù¥Ïñ¥ Ï§ë Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÌîåÎ†àÏù¥Ïñ¥ Ï∞æÍ∏∞
        gameState.players.forEach(player => {
            if (player.health <= 0) return;
            
            const distance = calculateDistance(gameState.position, player.position);
            if (distance < nearestDistance) {
                nearestDistance = distance;
                nearestPlayer = player;
            }
        });
        
        if (nearestPlayer && nearestDistance < 100) { // 100m Ïù¥ÎÇ¥ÏóêÏÑúÎßå Î™ÖÏ§ë Í∞ÄÎä•
            // Ï°∞Ï§Ä Ï†ïÌôïÎèÑ Í≥ÑÏÇ∞ (Í±∞Î¶¨ Í∏∞Î∞ò)
            const accuracy = Math.max(0, 1 - (nearestDistance / 100));
            const hitChance = accuracy * 0.6 + 0.2; // 20-80% Î™ÖÏ§ëÎ•†
            
            if (Math.random() < hitChance) {
                // Î™ÖÏ§ë!
                const damage = Math.floor(Math.random() * 25) + 25; // 25-50 Îç∞ÎØ∏ÏßÄ
                nearestPlayer.health = Math.max(0, nearestPlayer.health - damage);
                
                // ÌîºÌï¥ Ï†ïÎ≥¥Î•º Ìï¥Îãπ ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤å Ï†ÑÏÜ°
                sendPeerMessage(nearestPlayer.id, {
                    type: 'hit',
                    data: {
                        damage: damage,
                        shooterId: gameState.playerId,
                        shooterName: gameState.playerName,
                        remainingHealth: nearestPlayer.health
                    }
                });
                
                if (nearestPlayer.health <= 0) {
                    // ÌîåÎ†àÏù¥Ïñ¥ Ï†úÍ±∞
                    gameState.kills++;
                    showHitMarker(`${nearestPlayer.name} Ï†úÍ±∞! (+1 ÌÇ¨)`);
                    
                    // ÏÇ¨Îßù ÏïåÎ¶º Ï†ÑÏÜ°
                    broadcastMessage({
                        type: 'death',
                        data: {
                            playerId: nearestPlayer.id,
                            playerName: nearestPlayer.name,
                            killerId: gameState.playerId,
                            killerName: gameState.playerName
                        }
                    });
                    
                } else {
                    showHitMarker(`${nearestPlayer.name} Ï†ÅÏ§ë! (-${damage}HP)`);
                }
                
                return { hit: true, target: nearestPlayer.name, damage: damage };
            } else {
                showHitMarker('ÎπóÎÇòÍ∞ê');
                return { hit: false, target: nearestPlayer.name };
            }
        } else {
            showHitMarker('ÏÇ¨Ï†ïÍ±∞Î¶¨ Î∞ñ');
            return { hit: false, target: null };
        }
    }

    // Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥Ïùò Î∞úÏÇ¨ Ï≤òÎ¶¨
    function handlePeerShot(data, peerId) {
        // ÏãúÍ∞ÅÏ†Å/Ï≤≠Í∞ÅÏ†Å Ìö®Í≥º (Ï¥ùÏÜåÎ¶¨, Ï¥ùÍµ¨ ÏÑ¨Í¥ë Îì±)
        console.log(`${data.shooterName}Ïù¥ Î∞úÏÇ¨ÌñàÏäµÎãàÎã§`);
        
        // Í±∞Î¶¨ Í∏∞Î∞ò Ï¥ùÏÜåÎ¶¨ Î≥ºÎ•® Ï°∞Ï†à Îì±Ïùò Ìö®Í≥ºÎ•º Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§
    }

    // ÌîºÍ≤© Ï≤òÎ¶¨
    function handlePeerHit(data) {
        gameState.health = Math.max(0, data.remainingHealth);
        showHitMarker(`${data.shooterName}ÏóêÍ≤å ÌîºÍ≤©! (-${data.damage}HP)`);
        showHitEffect();
        
        if (gameState.health <= 0) {
            endGame('Ìå®Î∞∞', `${data.shooterName}ÏóêÍ≤å Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§!`);
        }
        
        updateGameUI();
    }

    // ÌîåÎ†àÏù¥Ïñ¥ ÏÇ¨Îßù Ï≤òÎ¶¨
    function handlePlayerDeath(data, peerId) {
        const player = gameState.players.get(peerId);
        if (player) {
            player.health = 0;
            showHitMarker(`${data.playerName}Ïù¥ ${data.killerName}ÏóêÍ≤å Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§`);
        }
    }

    // Î™ÖÏ§ë ÌëúÏãú
    function showHitMarker(message) {
        const marker = document.createElement('div');
        marker.style.cssText = `
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #00ff41;
            padding: 10px 20px;
            border-radius: 20px;
            border: 2px solid #00ff41;
            font-size: 16px;
            font-weight: bold;
            z-index: 180;
            pointer-events: none;
            animation: hitMarkerFade 2s ease-out forwards;
        `;
        marker.textContent = message;
        document.body.appendChild(marker);
        
        setTimeout(() => {
            marker.remove();
        }, 2000);
    }

    // ÌîºÍ≤© Ìö®Í≥º
    function showHitEffect() {
        const effect = document.createElement('div');
        effect.className = 'hit-effect';
        document.body.appendChild(effect);
        
        setTimeout(() => {
            effect.remove();
        }, 500);
        
        // ÏßÑÎèô
        if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
        }
    }

    // Ïû¨Ïû•Ï†Ñ
    function reload() {
        if (gameState.isReloading || gameState.ammo === gameState.maxAmmo || gameState.health <= 0) return;
        
        gameState.isReloading = true;
        showHitMarker('Ïû¨Ïû•Ï†Ñ Ï§ë...');
        
        setTimeout(() => {
            gameState.ammo = gameState.maxAmmo;
            gameState.isReloading = false;
            showHitMarker('Ïû¨Ïû•Ï†Ñ ÏôÑÎ£å!');
            updateGameUI();
        }, 2500);
    }

    // Í≤åÏûÑ Ï¢ÖÎ£å
    function endGame(title, message) {
        if (gameState.gameLoop) {
            clearInterval(gameState.gameLoop);
            gameState.gameLoop = null;
        }
        if (gameState.pingInterval) {
            clearInterval(gameState.pingInterval);
            gameState.pingInterval = null;
        }
        
        showStatus(title, message);
    }

    // Í≤åÏûÑ ÎÇòÍ∞ÄÍ∏∞
    function leaveGame() {
        if (gameState.gameLoop) {
            clearInterval(gameState.gameLoop);
            gameState.gameLoop = null;
        }
        if (gameState.pingInterval) {
            clearInterval(gameState.pingInterval);
            gameState.pingInterval = null;
        }
        
        // P2P Ïó∞Í≤∞ Ï†ïÎ¶¨
        gameState.connections.forEach((connection, peerId) => {
            if (connection.peerConnection) {
                connection.peerConnection.close();
            }
        });
        gameState.connections.clear();
        gameState.players.clear();
        
        // ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤ÑÏóê ÎÇòÍ∞ÄÍ∏∞ ÏïåÎ¶º
        sendSignalingMessage({
            type: 'leave-game',
            roomCode: gameState.roomCode,
            playerId: gameState.playerId
        });
        
        showScreen('lobby');
    }

    // Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    function updateConnectionStatus(status) {
        const statusEl = document.getElementById('connectionStatus');
        statusEl.className = `connection-status ${status}`;
        
        switch (status) {
            case 'connected':
                statusEl.textContent = 'üü¢ Ïó∞Í≤∞Îê®';
                break;
            case 'connecting':
                statusEl.textContent = 'üü° Ïó∞Í≤∞ Ï§ë...';
                break;
            case 'disconnected':
                statusEl.textContent = 'üî¥ Ïó∞Í≤∞ ÎÅäÍπÄ';
                break;
        }
    }

    // ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú
    function showStatus(title, message) {
        document.getElementById('statusTitle').textContent = title;
        document.getElementById('statusMessage').textContent = message;
        document.getElementById('statusOverlay').classList.remove('hidden');
    }

    // ÏÉÅÌÉú Î©îÏãúÏßÄ Îã´Í∏∞
    function closeStatus() {
        document.getElementById('statusOverlay').classList.add('hidden');
    }

    // ÏãúÍ∑∏ÎÑêÎßÅ Î©îÏãúÏßÄ Ìï∏Îì§Îü¨Îì§
    function handlePlayerJoin(message) {
        console.log('ÌîåÎ†àÏù¥Ïñ¥ Ï∞∏Í∞Ä:', message.playerName);
        // Í∏∞Ï°¥ ÌîåÎ†àÏù¥Ïñ¥Ïù∏ Í≤ΩÏö∞ WebRTC Ïó∞Í≤∞ ÏãúÏûë
        if (gameState.isHost) {
            createOffer(message.playerId);
        }
    }

    function handleOffer(message) {
        if (message.targetId === gameState.playerId) {
            handleRemoteOffer(message);
        }
    }

    function handleAnswer(message) {
        if (message.targetId === gameState.playerId) {
            handleRemoteAnswer(message);
        }
    }

    function handleIceCandidate(message) {
        if (message.targetId === gameState.playerId) {
            handleRemoteIceCandidate(message);
        }
    }

    function handlePlayerLeave(message) {
        console.log('ÌîåÎ†àÏù¥Ïñ¥ ÎÇòÍ∞ê:', message.playerId);
        const connection = gameState.connections.get(message.playerId);
        if (connection) {
            connection.peerConnection.close();
            gameState.connections.delete(message.playerId);
        }
        gameState.players.delete(message.playerId);
        updateConnectedCount();
    }

    function handleGameStart(message) {
        if (!gameState.isHost) {
            initializeGame();
        }
    }

    // WebRTC Offer ÏÉùÏÑ±
    async function createOffer(peerId) {
        try {
            const peerConnection = createPeerConnection(peerId);
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            sendSignalingMessage({
                type: 'offer',
                roomCode: gameState.roomCode,
                senderId: gameState.playerId,
                targetId: peerId,
                offer: offer
            });
        } catch (error) {
            console.error('Offer ÏÉùÏÑ± Ïã§Ìå®:', error);
        }
    }

    // WebRTC Offer Ï≤òÎ¶¨
    async function handleRemoteOffer(message) {
        try {
            const peerConnection = createPeerConnection(message.senderId);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            sendSignalingMessage({
                type: 'answer',
                roomCode: gameState.roomCode,
                senderId: gameState.playerId,
                targetId: message.senderId,
                answer: answer
            });
        } catch (error) {
            console.error('Offer Ï≤òÎ¶¨ Ïã§Ìå®:', error);
        }
    }

    // WebRTC Answer Ï≤òÎ¶¨
    async function handleRemoteAnswer(message) {
        try {
            const connection = gameState.connections.get(message.senderId);
            if (connection && connection.peerConnection) {
                await connection.peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
            }
        } catch (error) {
            console.error('Answer Ï≤òÎ¶¨ Ïã§Ìå®:', error);
        }
    }

    // ICE Candidate Ï≤òÎ¶¨
    async function handleRemoteIceCandidate(message) {
        try {
            const connection = gameState.connections.get(message.senderId);
            if (connection && connection.peerConnection) {
                await connection.peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
            }
        } catch (error) {
            console.error('ICE Candidate Ï≤òÎ¶¨ Ïã§Ìå®:', error);
        }
    }

    // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ (Îç∞Ïä§ÌÅ¨ÌÜ±ÏóêÏÑú ÌÖåÏä§Ìä∏Ïö©)
    document.addEventListener('keydown', (event) => {
        if (gameState.screen === 'game') {
            switch (event.code) {
                case 'Space':
                    event.preventDefault();
                    startShooting();
                    setTimeout(stopShooting, 100);
                    break;
                case 'KeyR':
                    event.preventDefault();
                    reload();
                    break;
                case 'Escape':
                    event.preventDefault();
                    leaveGame();
                    break;
            }
        }
    });

    // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ Í∞úÏÑ†
    document.getElementById('shootButton').addEventListener('touchstart', (e) => {
        e.preventDefault();
        startShooting();
    });
    
    document.getElementById('shootButton').addEventListener('touchend', (e) => {
        e.preventDefault();
        stopShooting();
    });

    // Î∞© ÏΩîÎìú ÏûÖÎ†•ÏóêÏÑú ÏóîÌÑ∞ÌÇ§ Ï≤òÎ¶¨
    document.getElementById('roomCodeInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            joinRoom();
        }
    });

    // Î∞©Ìñ• Î≥ÄÌôî Í∞êÏßÄ (ÌôîÎ©¥ ÌöåÏ†Ñ Î∞©ÏßÄ)
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            window.scrollTo(0, 1);
        }, 100);
    });

    // ÌôîÎ©¥ Í∫ºÏßê Î∞©ÏßÄ
    let wakeLock = null;
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
            }
        } catch (err) {
            console.log('ÌôîÎ©¥ Ïú†ÏßÄ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§:', err);
        }
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
    window.addEventListener('DOMContentLoaded', () => {
        init();
        
        // Í≤åÏûÑ ÏãúÏûëÏãú ÌôîÎ©¥ Ïú†ÏßÄ ÏöîÏ≤≠
        document.addEventListener('click', requestWakeLock, { once: true });
    });

    // ÌéòÏù¥ÏßÄ Î≤óÏñ¥ÎÇ† Îïå Ï†ïÎ¶¨
    window.addEventListener('beforeunload', () => {
        if (wakeLock) {
            wakeLock.release();
        }
        
        // Î™®Îì† Ïó∞Í≤∞ Ï†ïÎ¶¨
        gameState.connections.forEach((connection) => {
            if (connection.peerConnection) {
                connection.peerConnection.close();
            }
        });
        
        if (gameState.signaling) {
            gameState.signaling.close();
        }
        
        if (gameState.gameLoop) {
            clearInterval(gameState.gameLoop);
        }
        
        if (gameState.pingInterval) {
            clearInterval(gameState.pingInterval);
        }
    });

    // Îç∞Î™®Ïö© AI ÏãúÎÆ¨Î†àÏù¥ÏÖò (Ïã§Ï†ú ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏóÜÏùÑ Îïå)
    function addDemoPlayers() {
        if (gameState.connections.size === 0 && gameState.screen === 'game') {
            // Í∞ÄÏÉÅÏùò ÌîåÎ†àÏù¥Ïñ¥Îì§ ÏÉùÏÑ±
            for (let i = 1; i <= 2; i++) {
                const virtualPlayer = {
                    id: `demo_player_${i}`,
                    name: generateRandomName(),
                    health: 100,
                    position: {
                        lat: gameState.position.lat + (Math.random() - 0.5) * 0.002,
                        lng: gameState.position.lng + (Math.random() - 0.5) * 0.002
                    },
                    lastSeen: Date.now()
                };
                gameState.players.set(virtualPlayer.id, virtualPlayer);
            }
            
            updateGameUI();
        }
    }

    // Îç∞Î™® AI ÌñâÎèô
    function simulateDemoAI() {
        if (gameState.screen !== 'game' || gameState.connections.size > 0) return;
        
        gameState.players.forEach((player, id) => {
            if (id.startsWith('demo_player_') && player.health > 0) {
                // ÎûúÎç§ Ïù¥Îèô
                player.position.lat += (Math.random() - 0.5) * 0.0001;
                player.position.lng += (Math.random() - 0.5) * 0.0001;
                
                // Í∞ÄÎÅî ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤å ÌîºÌï¥Î•º Ï§å
                if (Math.random() < 0.005) { // 0.5% ÌôïÎ•†
                    const distance = calculateDistance(gameState.position, player.position);
                    if (distance < 50 && gameState.health > 0) { // 50m Ïù¥ÎÇ¥
                        const damage = Math.floor(Math.random() * 20 + 10);
                        gameState.health = Math.max(0, gameState.health - damage);
                        showHitMarker(`${player.name}ÏóêÍ≤å ÌîºÍ≤©! (-${damage}HP)`);
                        showHitEffect();
                        
                        if (gameState.health <= 0) {
                            endGame('Ìå®Î∞∞', `${player.name}ÏóêÍ≤å Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§!`);
                        }
                        updateGameUI();
                    }
                }
            }
        });
    }

    // Îç∞Î™® ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÏûë
    setInterval(() => {
        addDemoPlayers();
        simulateDemoAI();
    }, 100);

    // Ïã§Ï†ú ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ Íµ¨ÌòÑ ÏòàÏ†ú (Firebase ÏÇ¨Ïö© Ïãú)
    /*
    function initFirebaseSignaling() {
        // Firebase Íµ¨ÏÑ±
        const firebaseConfig = {
            // Firebase ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï
        };
        
        // Firebase Ï¥àÍ∏∞Ìôî
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Î∞© ÏÉùÏÑ±/Ï∞∏Í∞Ä
        function createFirebaseRoom() {
            const roomRef = database.ref('rooms/' + gameState.roomCode);
            roomRef.set({
                host: gameState.playerId,
                created: Date.now(),
                players: {
                    [gameState.playerId]: {
                        name: gameState.playerName,
                        isHost: true,
                        lastSeen: Date.now()
                    }
                }
            });
            
            // ÌîåÎ†àÏù¥Ïñ¥ Ï∞∏Í∞Ä Í∞êÏßÄ
            roomRef.child('players').on('child_added', (snapshot) => {
                const playerId = snapshot.key;
                const playerData = snapshot.val();
                
                if (playerId !== gameState.playerId) {
                    console.log('ÏÉà ÌîåÎ†àÏù¥Ïñ¥ Ï∞∏Í∞Ä:', playerData.name);
                    if (gameState.isHost) {
                        createOffer(playerId);
                    }
                }
            });
        }
        
        function joinFirebaseRoom() {
            const roomRef = database.ref('rooms/' + gameState.roomCode);
            roomRef.child('players/' + gameState.playerId).set({
                name: gameState.playerName,
                isHost: false,
                lastSeen: Date.now()
            });
            
            // ÏãúÍ∑∏ÎÑêÎßÅ Î©îÏãúÏßÄ Ï≤òÎ¶¨
            roomRef.child('signals').on('child_added', (snapshot) => {
                const signal = snapshot.val();
                if (signal.targetId === gameState.playerId) {
                    handleSignalingMessage(signal);
                    // Î©îÏãúÏßÄ ÏÇ≠Ï†ú
                    snapshot.ref.remove();
                }
            });
        }
        
        function sendFirebaseSignal(message) {
            const roomRef = database.ref('rooms/' + gameState.roomCode + '/signals');
            roomRef.push(message);
        }
    }
    */

    // Socket.io ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ Íµ¨ÌòÑ ÏòàÏ†ú
    /*
    function initSocketSignaling() {
        const socket = io('https://your-signaling-server.com');
        
        socket.on('connect', () => {
            console.log('ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®');
            updateConnectionStatus('connected');
        });
        
        socket.on('disconnect', () => {
            console.log('ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÎÅäÍπÄ');
            updateConnectionStatus('disconnected');
        });
        
        socket.on('room-created', (data) => {
            console.log('Î∞© ÏÉùÏÑ±Îê®:', data.roomCode);
        });
        
        socket.on('player-joined', (data) => {
            console.log('ÌîåÎ†àÏù¥Ïñ¥ Ï∞∏Í∞Ä:', data.playerName);
            if (gameState.isHost) {
                createOffer(data.playerId);
            }
        });
        
        socket.on('signal', (data) => {
            handleSignalingMessage(data);
        });
        
        // Î∞© ÏÉùÏÑ±
        function createSocketRoom() {
            socket.emit('create-room', {
                roomCode: gameState.roomCode,
                playerId: gameState.playerId,
                playerName: gameState.playerName
            });
        }
        
        // Î∞© Ï∞∏Í∞Ä
        function joinSocketRoom() {
            socket.emit('join-room', {
                roomCode: gameState.roomCode,
                playerId: gameState.playerId,
                playerName: gameState.playerName
            });
        }
        
        // ÏãúÍ∑∏ÎÑêÎßÅ Î©îÏãúÏßÄ Ï†ÑÏÜ°
        function sendSocketSignal(message) {
            socket.emit('signal', message);
        }
    }
    */

    // PWA Îß§ÎãàÌéòÏä§Ìä∏
    const manifest = {
        name: "PUBG AR - Ïã§ÏãúÍ∞Ñ Î∞∞ÌãÄÎ°úÏñÑ",
        short_name: "PUBG AR",
        description: "Ïã§ÏãúÍ∞Ñ P2P Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Ï¶ùÍ∞ïÌòÑÏã§ Î∞∞ÌãÄÎ°úÏñÑ Í≤åÏûÑ",
        start_url: "/",
        display: "standalone",
        background_color: "#1a1a2e",
        theme_color: "#00ff41",
        orientation: "portrait",
        icons: [
            {
                src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMWExYTJlIi8+Cjx0ZXh0IHg9Ijk2IiB5PSIxMTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI2MCIgZmlsbD0iIzAwZmY0MSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+OvzwvdGV4dD4KPC9zdmc+",
                sizes: "192x192",
                type: "image/svg+xml"
            }
        ]
    };

    // ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const swCode = `
                const CACHE_NAME = 'pubg-ar-multiplayer-v1';
                const urlsToCache = [
                    '/',
                    '/manifest.json'
                ];
                
                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then((cache) => cache.addAll(urlsToCache))
                    );
                });
                
                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request)
                            .then((response) => {
                                // Ï∫êÏãúÎêú Î≤ÑÏ†ÑÏù¥ ÏûàÏúºÎ©¥ Î∞òÌôò, ÏóÜÏúºÎ©¥ ÎÑ§Ìä∏ÏõåÌÅ¨ÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
                                return response || fetch(event.request);
                            })
                    );
                });
                
                // Ìë∏Ïãú ÏïåÎ¶º Ï≤òÎ¶¨ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                self.addEventListener('push', (event) => {
                    const options = {
                        body: event.data ? event.data.text() : 'ÏÉàÎ°úÏö¥ Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!',
                        icon: '/icon-192x192.png',
                        badge: '/badge-72x72.png',
                        vibrate: [100, 50, 100],
                        data: {
                            dateOfArrival: Date.now(),
                            primaryKey: '1'
                        }
                    };
                    
                    event.waitUntil(
                        self.registration.showNotification('PUBG AR', options)
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then((registration) => {
                    console.log('ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù ÏôÑÎ£å:', registration.scope);
                })
                .catch((error) => {
                    console.log('ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù Ïã§Ìå®:', error);
                });
        });
    }

    // Îß§ÎãàÌéòÏä§Ìä∏ ÎèôÏ†Å ÏÉùÏÑ±
    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestUrl = URL.createObjectURL(manifestBlob);
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestUrl;
    document.head.appendChild(link);

    // ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ ÌëúÏãú (Í∞úÎ∞úÏö©)
    function showDebugInfo() {
        if (gameState.screen === 'game') {
            console.log('=== Í≤åÏûÑ ÏÉÅÌÉú ===');
            console.log('ÌîåÎ†àÏù¥Ïñ¥ Ïàò:', gameState.players.size);
            console.log('Ïó∞Í≤∞ Ïàò:', gameState.connections.size);
            console.log('ÏúÑÏπò:', gameState.position);
            console.log('Ï≤¥Î†•:', gameState.health);
            console.log('ÌÉÑÏïΩ:', gameState.ammo);
            console.log('=================');
        }
    }

    // ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ Ï£ºÍ∏∞Ï†Å Ï∂úÎ†• (Í∞úÎ∞úÏö©)
    setInterval(showDebugInfo, 10000);

    // Ïó∞Í≤∞ ÌíàÏßà Î™®ÎãàÌÑ∞ÎßÅ
    function monitorConnectionQuality() {
        gameState.connections.forEach((connection, peerId) => {
            if (connection.peerConnection) {
                connection.peerConnection.getStats().then(stats => {
                    stats.forEach(report => {
                        if (report.type === 'data-channel') {
                            console.log(`${peerId} Îç∞Ïù¥ÌÑ∞ Ï±ÑÎÑê ÌÜµÍ≥Ñ:`, {
                                bytesReceived: report.bytesReceived,
                                bytesSent: report.bytesSent,
                                messagesReceived: report.messagesReceived,
                                messagesSent: report.messagesSent
                            });
                        }
                    });
                }).catch(console.error);
            }
        });
    }

    // Ïó∞Í≤∞ ÌíàÏßà Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë (5Ï¥àÎßàÎã§)
    setInterval(monitorConnectionQuality, 5000);

    // Ïï± ÏÑ§Ïπò ÌîÑÎ°¨ÌîÑÌä∏ Ï≤òÎ¶¨
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        // Í∏∞Î≥∏ ÏÑ§Ïπò ÌîÑÎ°¨ÌîÑÌä∏ Î∞©ÏßÄ
        e.preventDefault();
        // ÎÇòÏ§ëÏóê ÏÇ¨Ïö©ÌïòÍ∏∞ ÏúÑÌï¥ Ïù¥Î≤§Ìä∏ Ï†ÄÏû•
        deferredPrompt = e;
        
        // ÏÇ¨Ïö©ÏûêÏóêÍ≤å Ïï± ÏÑ§Ïπò ÏòµÏÖò ÌëúÏãú
        showInstallButton();
    });

    function showInstallButton() {
        // ÏÑ§Ïπò Î≤ÑÌäº ÌëúÏãú Î°úÏßÅ
        const installBtn = document.createElement('button');
        installBtn.textContent = 'üì± Ïï± ÏÑ§Ïπò';
        installBtn.className = 'btn btn-info';
        installBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 200;';
        installBtn.onclick = installApp;
        document.body.appendChild(installBtn);
    }

    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('ÏÇ¨Ïö©ÏûêÍ∞Ä Ïï± ÏÑ§ÏπòÏóê ÎèôÏùòÌñàÏäµÎãàÎã§');
                }
                deferredPrompt = null;
            });
        }
    }

    // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ
    function updateNetworkStatus() {
        const isOnline = navigator.onLine;
        const statusEl = document.getElementById('connectionStatus');
        
        if (!isOnline) {
            statusEl.textContent = 'üî¥ Ïò§ÌîÑÎùºÏù∏';
            statusEl.className = 'connection-status disconnected';
        }
    }

    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);

    // ÏÑ±Îä• ÏµúÏ†ÅÌôî: requestAnimationFrameÏùÑ Ïù¥Ïö©Ìïú Î∂ÄÎìúÎü¨Ïö¥ ÏóÖÎç∞Ïù¥Ìä∏
    let lastFrameTime = 0;
    function gameRenderLoop(currentTime) {
        const deltaTime = currentTime - lastFrameTime;
        
        if (gameState.screen === 'game' && deltaTime >= 16) { // 60fps Ï†úÌïú
            updateRadar();
            lastFrameTime = currentTime;
        }
        
        requestAnimationFrame(gameRenderLoop);
    }
    
    // Î†åÎçîÎßÅ Î£®ÌîÑ ÏãúÏûë
    requestAnimationFrame(gameRenderLoop);

    console.log('üéÆ PUBG AR Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î°úÎìú ÏôÑÎ£å!');
    console.log('üì± Ïã§Ï†ú Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥Î•º ÏúÑÌï¥ÏÑúÎäî ÏãúÍ∑∏ÎÑêÎßÅ ÏÑúÎ≤ÑÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
    console.log('üîß Firebase, Socket.io, ÎòêÎäî WebSocket ÏÑúÎ≤ÑÎ•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.');
</script>
```

</body>
</html>
