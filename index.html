<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Real Battle AR â€” HTML Prototype</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; touch-action:none; }
    #app { position:fixed; inset:0; }
    video#cam { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform:scaleX(-1); } /* ì…€í”¼ ëŠë‚Œ ë¯¸ëŸ¬ */
    canvas#hud { position:absolute; inset:0; pointer-events:none; }
    .ui {
      position:absolute; left:0; right:0; bottom:0;
      display:flex; justify-content:space-between; align-items:flex-end;
      padding:16px; gap:12px; pointer-events:none;
    }
    .pill {
      background:rgba(0,0,0,.45); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji;
      padding:8px 12px; border-radius:999px; font-size:14px; backdrop-filter:blur(6px);
      pointer-events:auto; user-select:none;
    }
    #fireBtn { font-size:16px; padding:14px 18px; border:2px solid rgba(255,255,255,.2); }
    #msg { position:absolute; top:10px; left:50%; transform:translateX(-50%); color:#fff; font-family:system-ui; font-size:14px; background:rgba(0,0,0,.45); padding:6px 10px; border-radius:10px; }
    #scopeDot {
      position:absolute; left:50%; top:50%; width:22px; height:22px; margin:-11px 0 0 -11px;
      border:2px solid rgba(255,255,255,.9); border-radius:50%;
      box-shadow:0 0 0 1px rgba(0,0,0,.5), 0 0 10px rgba(255,255,255,.35) inset;
      pointer-events:none;
    }
    #muzzle {
      position:absolute; left:50%; top:55%; width:120px; height:120px; margin:-60px 0 0 -60px; border-radius:50%;
      background:radial-gradient(circle, rgba(255,230,120,.95) 0%, rgba(255,120,20,.65) 40%, rgba(255,0,0,.0) 70%);
      opacity:0; transform:scale(.5); filter:blur(2px); pointer-events:none;
      mix-blend-mode:screen;
    }
    .hitFlash {
      position:absolute; inset:0; background:rgba(255,255,255,.15); pointer-events:none; opacity:0; transition:opacity .18s ease;
    }
    .qrBox {
      position:absolute; border:2px dashed #00ff88; box-shadow:0 0 8px rgba(0,255,136,.6); pointer-events:none;
    }
  </style>
</head>
<body>
  <div id="app">
    <video id="cam" playsinline autoplay muted></video>
    <canvas id="hud"></canvas>
    <div id="scopeDot" aria-hidden="true"></div>
    <div id="muzzle" aria-hidden="true"></div>
    <div id="msg">ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•˜ê³ , í™”ë©´ íƒ­ ë˜ëŠ” ğŸ”Šë³¼ë¥¨ ë²„íŠ¼ìœ¼ë¡œ ë°œì‚¬ â€¢ ìœ„ë¡œ ìŠ¤ì™€ì´í”„=ì¥ì „</div>

    <div class="ui">
      <div class="pill">HP: <span id="hp">100</span></div>
      <button class="pill" id="fireBtn">ğŸ”« FIRE</button>
      <div class="pill">Ammo: <span id="ammo">8</span> / 8</div>
    </div>
    <div class="hitFlash" id="hitFx"></div>
  </div>

  <script>
    // ---- State ----
    const state = {
      ammo: 8, clip: 8, reloading: false,
      hp: 100,
      lastShot: 0,
      supportsBarcode: 'BarcodeDetector' in window,
      detectors: null,
      qrTargets: [], // {x,y,w,h, rawValue}
      wakeLock: null,
    };

    const video = document.getElementById('cam');
    const hud = document.getElementById('hud');
    const ctx = hud.getContext('2d', { alpha: true });
    const ammoEl = document.getElementById('ammo');
    const hpEl = document.getElementById('hp');
    const fireBtn = document.getElementById('fireBtn');
    const muzzle = document.getElementById('muzzle');
    const hitFx = document.getElementById('hitFx');
    const msg = document.getElementById('msg');

    // ---- Camera ----
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }, audio: false
        });
        video.srcObject = stream;
        await video.play();
        resize();
        info('ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ');
      } catch (e) {
        info('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ê¶Œí•œ/HTTPS í•„ìš”. (ì˜ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤: ê¸°ê¸°ë³„ ì •ì±…ì°¨)');
        console.error(e);
      }
    }

    // ---- Resize ----
    function resize() {
      hud.width = innerWidth;
      hud.height = innerHeight;
    }
    addEventListener('resize', resize);

    // ---- Wake Lock (í™”ë©´ êº¼ì§ ë°©ì§€) ----
    async function keepAwake(on) {
      try {
        if (on && 'wakeLock' in navigator) {
          state.wakeLock = await navigator.wakeLock.request('screen');
        } else if (state.wakeLock) {
          state.wakeLock.release(); state.wakeLock = null;
        }
      } catch (_) { /* ê¸°ê¸°ë³„ ë¯¸ì§€ì› ê°€ëŠ¥ */ }
    }

    // ---- Simple SFX (WebAudio) ----
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playShot() {
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'square'; o.frequency.value = 220;
      g.gain.setValueAtTime(0.001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.6, audioCtx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15);
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.16);
    }
    function playReload() {
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'triangle'; o.frequency.value = 600;
      g.gain.setValueAtTime(0.001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.25);
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.26);
    }

    // ---- Shooting / Reload ----
    function updateAmmo() { ammoEl.textContent = state.ammo; hpEl.textContent = state.hp; }
    function muzzleFlash() {
      muzzle.style.transition = 'none';
      muzzle.style.opacity = '1'; muzzle.style.transform = 'scale(1.0)';
      requestAnimationFrame(() => {
        muzzle.style.transition = 'opacity .12s ease, transform .12s ease';
        muzzle.style.opacity = '0'; muzzle.style.transform = 'scale(1.4)';
      });
    }
    function screenHitFlash() {
      hitFx.style.opacity = '1';
      setTimeout(()=> hitFx.style.opacity = '0', 120);
    }
    function fire() {
      const now = performance.now();
      if (now - state.lastShot < 120) return; // rate limit
      if (state.reloading) return;
      if (state.ammo <= 0) { info('íƒ„ì•½ ì—†ìŒ! ìœ„ë¡œ ìŠ¤ì™€ì´í”„=ì¥ì „'); return; }
      state.ammo--; updateAmmo();
      state.lastShot = now;
      playShot(); muzzleFlash(); screenHitFlash();
      checkHit();
    }
    function reload() {
      if (state.reloading) return;
      state.reloading = true;
      info('ì¥ì „ ì¤‘...');
      setTimeout(()=>{
        state.ammo = state.clip; state.reloading = false; updateAmmo();
        playReload(); info('ì¥ì „ ì™„ë£Œ');
      }, 800);
    }

    // ---- Gesture: tap to fire, swipe up to reload ----
    let touchStartY = 0;
    addEventListener('touchstart', (e)=>{
      if (e.target === fireBtn) return;
      touchStartY = e.touches[0].clientY;
    }, {passive:true});
    addEventListener('touchend', (e)=>{
      const endY = (e.changedTouches[0]||{}).clientY || 0;
      if (touchStartY - endY > 60) reload(); else fire();
    });
    fireBtn.addEventListener('click', fire);

    // ---- Volume buttons -> fire (ê°€ëŠ¥ ê¸°ê¸° í•œì •, ì˜ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤) ----
    // ì¼ë¶€ ë¸Œë¼ìš°ì €ëŠ” ë³¼ë¥¨í‚¤ ì´ë²¤íŠ¸ ì ‘ê·¼ ë¶ˆê°€. ë¯¸ì§€ì›ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    // ---- QR detection (BarcodeDetector) ----
    let detector = null;
    async function setupBarcode() {
      if (!state.supportsBarcode) { info('QR ê°ì§€ ë¯¸ì§€ì›(ë¸Œë¼ìš°ì €)'); return; }
      try {
        detector = new BarcodeDetector({ formats: ['qr_code'] });
        info('QR ê°ì§€ í™œì„±í™”');
      } catch (e) {
        info('QR ê°ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨(ì˜ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤: ê¸°ê¸°/ê¶Œí•œ ì°¨)'); console.warn(e);
      }
    }

    // ---- Draw HUD & QR boxes ----
    function drawHUD() {
      ctx.clearRect(0,0,hud.width,hud.height);
      // ì¡°ì¤€ì„  ê°„ë‹¨ ë¼ì¸
      const cx = hud.width/2, cy = hud.height/2;
      ctx.globalAlpha = 0.8;
      ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(255,255,255,.7)';
      ctx.beginPath();
      ctx.moveTo(cx-40, cy); ctx.lineTo(cx-14, cy);
      ctx.moveTo(cx+14, cy); ctx.lineTo(cx+40, cy);
      ctx.moveTo(cx, cy-40); ctx.lineTo(cx, cy-14);
      ctx.moveTo(cx, cy+14); ctx.lineTo(cx, cy+40);
      ctx.stroke();

      // QR ë°•ìŠ¤ ê·¸ë¦¬ê¸°
      state.qrTargets.forEach(b => {
        // ë¹„ë””ì˜¤ ì¢Œí‘œê³„ -> ë·°í¬íŠ¸ ì¢Œí‘œ ì¶”ì • (ë‹¨ìˆœ ìŠ¤ì¼€ì¼ ê°€ì •, ì¶”ì¸¡ì…ë‹ˆë‹¤)
        const x = b.boundingBox.x * (hud.width / video.videoWidth);
        const y = b.boundingBox.y * (hud.height / video.videoHeight);
        const w = b.boundingBox.width * (hud.width / video.videoWidth);
        const h = b.boundingBox.height * (hud.height / video.videoHeight);
        ctx.strokeStyle = 'rgba(0,255,136,.9)'; ctx.setLineDash([6,4]);
        ctx.lineWidth = 3; ctx.strokeRect(x,y,w,h);
        ctx.setLineDash([]);
        ctx.font = '12px system-ui'; ctx.fillStyle='rgba(0,255,136,.9)';
        ctx.fillText(b.rawValue || 'QR', x+4, y-6);
      });
      requestAnimationFrame(drawHUD);
    }

    // ---- Hit test: crosshair center in QR box? ----
    function checkHit() {
      if (!state.qrTargets.length) return;
      const cx = hud.width/2, cy = hud.height/2;
      for (const b of state.qrTargets) {
        const x = b.boundingBox.x * (hud.width / video.videoWidth);
        const y = b.boundingBox.y * (hud.height / video.videoHeight);
        const w = b.boundingBox.width * (hud.width / video.videoWidth);
        const h = b.boundingBox.height * (hud.height / video.videoHeight);
        if (cx >= x && cx <= x+w && cy >= y && cy <= y+h) {
          // ë§ì¶¤!
          info(`HIT! (${b.rawValue || 'QR'})`);
          // ìƒëŒ€ ì²´ë ¥ ê¹ì´ëŠ” ë¡œì§ì€ ë„¤íŠ¸ì›Œí¬ ì—°ë™ ì‹œ êµ¬í˜„
          break;
        }
      }
    }

    // ---- QR scan loop ----
    async function scanLoop() {
      if (!detector || video.readyState < 2) { requestAnimationFrame(scanLoop); return; }
      try {
        const faces = await detector.detect(video);
        state.qrTargets = faces;
      } catch (e) {
        // ìŠ¤ìº” ì‹¤íŒ¨ëŠ” ë¬´ì‹œ(ì„±ëŠ¥/ê¶Œí•œ ì´ìŠˆ ê°€ëŠ¥)
      } finally {
        requestAnimationFrame(scanLoop);
      }
    }

    // ---- Utility ----
    let infoTimer = null;
    function info(t) {
      clearTimeout(infoTimer);
      msg.textContent = t;
      msg.style.opacity = '1';
      infoTimer = setTimeout(()=> msg.style.opacity = '0.0', 2000);
    }

    // ---- Init ----
    (async function init(){
      await startCamera();
      await setupBarcode();
      keepAwake(true);
      drawHUD();
      scanLoop();
      updateAmmo();
      // í™”ë©´ íƒ­ ì²« ì…ë ¥ ë•Œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ê¹¨ìš°ê¸°
      const kick = ()=> { audioCtx.resume?.(); removeEventListener('touchend', kick); };
      addEventListener('touchend', kick, {once:true});
    })();

    // ì •ë¦¬
    addEventListener('pagehide', ()=> keepAwake(false));
  </script>
</body>
</html>
