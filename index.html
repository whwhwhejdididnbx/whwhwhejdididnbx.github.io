<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>현실판 배그 P2P</title>
<style>
body { text-align:center; font-family:sans-serif; }
#status { margin:10px; font-weight:bold; }
#health { font-size:20px; color:red; }
button { font-size:16px; padding:5px 10px; margin:5px; }
</style>
</head>
<body>
<h1>현실판 배그 P2P</h1>

<div>
<p id="myId">방 코드: ...</p>
<input id="friendId" placeholder="친구 방 코드 입력">
<button id="connectBtn">친구 연결</button>
</div>

<div id="status">상태: 대기중</div>
<div>내 체력: <span id="health">100</span></div>
<button onclick="shoot()">발사</button>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
let health = 100;
let conn;
const statusDiv = document.getElementById("status");
const healthSpan = document.getElementById("health");

function log(msg){ statusDiv.innerText = "상태: "+msg; }

// PeerJS 생성
const myPeer = new Peer(); // PeerJS 무료 클라우드 서버 사용

myPeer.on('open', id => {
    document.getElementById('myId').innerText = "방 코드: " + id;
    log("대기중. 친구에게 방 코드 공유하세요.");
});

// 친구 연결 버튼
document.getElementById('connectBtn').onclick = () => {
    const peerId = document.getElementById('friendId').value;
    if(!peerId){ alert("친구 방 코드 입력!"); return; }
    conn = myPeer.connect(peerId);
    setupConnection();
};

// 친구가 나에게 연결 시
myPeer.on('connection', connection => {
    conn = connection;
    setupConnection();
});

// 연결 설정
function setupConnection(){
    conn.on('open', () => log("연결 완료! 총 발사 준비 완료"));
    conn.on('data', data => {
        if(data.type === 'shoot'){
            health -= 10;
            if(health<0) health=0;
            healthSpan.innerText = health;
            log("총 맞음! 내 체력:"+health);
        }
    });
}

// 총 발사 함수
function shoot(){
    if(conn && conn.open){
        conn.send({type:'shoot'});
        log("발사! 상대에게 신호 전송");
    } else {
        log("아직 연결되지 않음");
    }
}

// 핸드폰 흔들기 감지로 발사
window.addEventListener('devicemotion', e=>{
    const acc = e.accelerationIncludingGravity;
    if(!acc) return;
    const mag = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
    if(mag>20) shoot();
});
</script>
</body>
</html>
