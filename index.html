<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Real Battle AR â€” Multiplayer (1v1) Prototype</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; touch-action:none; }
    #app { position:fixed; inset:0; }
    video#cam { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; } /* ê¸°ë³¸: ë¯¸ëŸ¬ ì•„ë‹˜ */
    .flipX { transform: scaleX(-1); }
    canvas#hud { position:absolute; inset:0; pointer-events:none; }
    .ui {
      position:absolute; left:0; right:0; bottom:0;
      display:flex; justify-content:space-between; align-items:flex-end;
      padding:12px; gap:8px; pointer-events:none;
    }
    .pill {
      background:rgba(0,0,0,.45); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji;
      padding:8px 12px; border-radius:999px; font-size:14px; backdrop-filter:blur(6px);
      pointer-events:auto; user-select:none;
      border:1px solid rgba(255,255,255,.15);
    }
    #fireBtn { font-size:16px; padding:14px 18px; border:2px solid rgba(255,255,255,.25); }
    #msg { position:absolute; top:8px; left:50%; transform:translateX(-50%); color:#fff; font-family:system-ui; font-size:13px; background:rgba(0,0,0,.45); padding:6px 10px; border-radius:10px; }
    #scopeDot {
      position:absolute; left:50%; top:50%; width:22px; height:22px; margin:-11px 0 0 -11px;
      border:2px solid rgba(255,255,255,.9); border-radius:50%;
      box-shadow:0 0 0 1px rgba(0,0,0,.5), 0 0 10px rgba(255,255,255,.35) inset;
      pointer-events:none;
    }
    #muzzle {
      position:absolute; left:50%; top:55%; width:120px; height:120px; margin:-60px 0 0 -60px; border-radius:50%;
      background:radial-gradient(circle, rgba(255,230,120,.95) 0%, rgba(255,120,20,.65) 40%, rgba(255,0,0,.0) 70%);
      opacity:0; transform:scale(.5); filter:blur(2px); pointer-events:none;
      mix-blend-mode:screen;
    }
    .hitFlash { position:absolute; inset:0; background:rgba(255,255,255,.15); pointer-events:none; opacity:0; transition:opacity .18s ease; }
    #topBar {
      position:absolute; top:0; left:0; right:0; display:flex; gap:8px; align-items:center;
      padding:6px; z-index:10; pointer-events:auto;
    }
    #topBar .pill { display:flex; align-items:center; gap:6px; }
    #connectPanel {
      position:absolute; right:6px; top:44px; width: min(480px, 94vw); max-height: 70vh; overflow:auto;
      background:rgba(0,0,0,.55); color:#fff; padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      font-family:system-ui; font-size:12px; pointer-events:auto;
    }
    textarea { width:100%; height:80px; background:rgba(0,0,0,.4); color:#eee; border:1px solid rgba(255,255,255,.2); border-radius:8px; padding:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    button.small { padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); color:#fff; cursor:pointer; }
    label { display:block; margin:6px 0 2px; }
    #name { width:140px; }
    #remoteHP { font-weight:bold; }
  </style>
</head>
<body>
  <div id="app">
    <video id="cam" playsinline autoplay muted></video>
    <canvas id="hud"></canvas>
    <div id="scopeDot" aria-hidden="true"></div>
    <div id="muzzle" aria-hidden="true"></div>
    <div id="msg">ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•˜ê³ , í™”ë©´ íƒ­=ë°œì‚¬ â€¢ ìœ„ë¡œ ìŠ¤ì™€ì´í”„=ì¥ì „ â€¢ QR ì¡°ì¤€ì‹œ HIT</div>

    <div id="topBar">
      <div class="pill">ë‚´ HP: <span id="hp">100</span></div>
      <div class="pill">íƒ„ì•½: <span id="ammo">8</span> / 8</div>
      <div class="pill">ìƒëŒ€ HP: <span id="remoteHP">?</span></div>
      <div class="pill"><input id="name" placeholder="ë‚´ ë‹‰ë„¤ì„" value="Player" /></div>
      <div class="pill"><label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" id="flipX"> ì¢Œìš°ë°˜ì „</label></div>
      <div class="pill"><button class="small" id="toggleConnect">ğŸ”— ì—°ê²°</button></div>
    </div>

    <div class="ui">
      <button class="pill" id="fireBtn">ğŸ”« FIRE</button>
    </div>
    <div class="hitFlash" id="hitFx"></div>
  </div>

  <div id="connectPanel" hidden>
    <div><b>ë©€í‹°í”Œë ˆì´(1v1) â€” WebRTC ë³µë¶™ ì—°ê²°</b></div>
    <ol>
      <li><b>í˜¸ìŠ¤íŠ¸</b>: "Create Offer" â†’ í…ìŠ¤íŠ¸ ë³µì‚¬ â†’ ìƒëŒ€ì—ê²Œ ì „ë‹¬.</li>
      <li><b>ê²ŒìŠ¤íŠ¸</b>: ë°›ì€ Offerë¥¼ ì•„ë˜ ìƒìì— ë¶™ì—¬ë„£ê¸° â†’ "Create Answer" â†’ ìƒì„±ëœ Answerë¥¼ í˜¸ìŠ¤íŠ¸ì—ê²Œ ì „ë‹¬.</li>
      <li>í˜¸ìŠ¤íŠ¸: ë°›ì€ Answerë¥¼ ìƒìì— ë¶™ì—¬ë„£ê³  "Set Remote Answer".</li>
    </ol>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
      <div>
        <label>Local Offer</label>
        <textarea id="offerOut" readonly></textarea>
        <div style="display:flex; gap:6px; margin-top:4px;">
          <button class="small" id="btnCreateOffer">Create Offer</button>
          <button class="small" id="btnCopyOffer">Copy</button>
        </div>
      </div>
      <div>
        <label>Remote Offer (paste here)</label>
        <textarea id="offerIn"></textarea>
        <div style="display:flex; gap:6px; margin-top:4px;">
          <button class="small" id="btnCreateAnswer">Create Answer</button>
        </div>
      </div>
      <div>
        <label>Local Answer</label>
        <textarea id="answerOut" readonly></textarea>
        <div style="display:flex; gap:6px; margin-top:4px;">
          <button class="small" id="btnCopyAnswer">Copy</button>
        </div>
      </div>
      <div>
        <label>Remote Answer (paste here)</label>
        <textarea id="answerIn"></textarea>
        <div style="display:flex; gap:6px; margin-top:4px;">
          <button class="small" id="btnSetRemoteAnswer">Set Remote Answer</button>
        </div>
      </div>
    </div>
    <div style="margin-top:6px; opacity:.8;">ì—°ê²°ë˜ë©´ ìƒëŒ€ HP/ì´ë²¤íŠ¸ê°€ ë™ê¸°í™”ë©ë‹ˆë‹¤. STUNë§Œ ì‚¬ìš©(ì„œë²„ ì—†ìŒ) â€” ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì— ë”°ë¼ ì—°ê²°ì´ ì•ˆ ë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤(ì˜ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤).</div>
  </div>

  <!-- jsQR: QR/ë°”ì½”ë“œ ê°ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë¸Œë¼ìš°ì € í˜¸í™˜ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
  // ====== ìƒíƒœ ======
  const state = {
    ammo: 8, clip: 8, reloading: false,
    hp: 100,
    lastShot: 0,
    qrBox: null, // {points:[{x,y}*4], data}
    wakeLock: null,
    // RTC
    pc: null, dc: null, connected: false,
  };

  const video = document.getElementById('cam');
  const hud = document.getElementById('hud');
  const ctx = hud.getContext('2d', { alpha: true });
  const ammoEl = document.getElementById('ammo');
  const hpEl = document.getElementById('hp');
  const remoteHpEl = document.getElementById('remoteHP');
  const fireBtn = document.getElementById('fireBtn');
  const muzzle = document.getElementById('muzzle');
  const hitFx = document.getElementById('hitFx');
  const msg = document.getElementById('msg');
  const nameInput = document.getElementById('name');
  const flipX = document.getElementById('flipX');
  const connectPanel = document.getElementById('connectPanel');
  const toggleConnect = document.getElementById('toggleConnect');

  // RTC UI
  const offerOut = document.getElementById('offerOut');
  const offerIn = document.getElementById('offerIn');
  const answerOut = document.getElementById('answerOut');
  const answerIn = document.getElementById('answerIn');
  const btnCreateOffer = document.getElementById('btnCreateOffer');
  const btnCopyOffer = document.getElementById('btnCopyOffer');
  const btnCreateAnswer = document.getElementById('btnCreateAnswer');
  const btnCopyAnswer = document.getElementById('btnCopyAnswer');
  const btnSetRemoteAnswer = document.getElementById('btnSetRemoteAnswer');

  // ====== ì¹´ë©”ë¼ ======
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }, audio: false
      });
      video.srcObject = stream;
      await video.play();
      resize();
      info('ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ');
    } catch (e) {
      info('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: HTTPS/ê¶Œí•œ í•„ìš”');
      console.error(e);
    }
  }

  function resize() { hud.width = innerWidth; hud.height = innerHeight; }
  addEventListener('resize', resize);

  // ====== Wake Lock ======
  async function keepAwake(on) {
    try {
      if (on && 'wakeLock' in navigator) {
        state.wakeLock = await navigator.wakeLock.request('screen');
      } else if (state.wakeLock) {
        state.wakeLock.release(); state.wakeLock = null;
      }
    } catch (_) { /* ë¯¸ì§€ì› ê°€ëŠ¥ */ }
  }

  // ====== ì‚¬ìš´ë“œ ======
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playShot() {
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = 'square'; o.frequency.value = 220;
    g.gain.setValueAtTime(0.001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.6, audioCtx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15);
    o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.16);
  }
  function playReload() {
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = 'triangle'; o.frequency.value = 600;
    g.gain.setValueAtTime(0.001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.25);
    o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.26);
  }

  // ====== ì¡°ì‘ ======
  function updateHUDText() { ammoEl.textContent = state.ammo; hpEl.textContent = state.hp; }
  function muzzleFlash() {
    muzzle.style.transition = 'none';
    muzzle.style.opacity = '1'; muzzle.style.transform = 'scale(1.0)';
    requestAnimationFrame(() => {
      muzzle.style.transition = 'opacity .12s ease, transform .12s ease';
      muzzle.style.opacity = '0'; muzzle.style.transform = 'scale(1.4)';
    });
  }
  function screenHitFlash() { hitFx.style.opacity = '1'; setTimeout(()=> hitFx.style.opacity = '0', 120); }

  function fire() {
    const now = performance.now();
    if (now - state.lastShot < 120) return;
    if (state.reloading) return;
    if (state.ammo <= 0) { info('íƒ„ì•½ ì—†ìŒ! ìœ„ë¡œ ìŠ¤ì™€ì´í”„=ì¥ì „'); return; }
    state.ammo--; updateHUDText();
    state.lastShot = now;
    playShot(); muzzleFlash(); screenHitFlash();
    // ë¡œì»¬ íˆíŠ¸ íŒì •
    if (isCenterInQR()) {
      info('HIT!');
      send({ t:'hit', amt:20, by:nameInput.value || 'Player' });
    }
    // ë°œì‚¬ ì´ë²¤íŠ¸ ì•Œë¦¼(ì—°ì¶œìš©)
    send({ t:'fire' });
  }

  function reload() {
    if (state.reloading) return;
    state.reloading = true; info('ì¥ì „ ì¤‘...');
    setTimeout(()=> {
      state.ammo = state.clip; state.reloading = false; updateHUDText();
      playReload(); info('ì¥ì „ ì™„ë£Œ');
    }, 800);
  }

  let touchStartY = 0;
  addEventListener('touchstart', (e)=>{
    if (e.target === fireBtn) return;
    touchStartY = e.touches[0].clientY;
  }, {passive:true});
  addEventListener('touchend', (e)=>{
    const endY = (e.changedTouches[0]||{}).clientY || 0;
    if (touchStartY - endY > 60) reload(); else fire();
  });
  fireBtn.addEventListener('click', fire);

  // ====== QR (jsQR) ======
  // jsQRëŠ” ìº”ë²„ìŠ¤ í”½ì…€ë¡œ ë¶„ì„í•¨. video -> hidden canvas -> imageData -> jsQR
  const scanCanvas = document.createElement('canvas');
  const scanCtx = scanCanvas.getContext('2d', { willReadFrequently:true });

  function drawHUD() {
    ctx.clearRect(0,0,hud.width,hud.height);
    // ì‹­ìì„ 
    const cx = hud.width/2, cy = hud.height/2;
    ctx.globalAlpha = 0.85;
    ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(255,255,255,.7)';
    ctx.beginPath();
    ctx.moveTo(cx-40, cy); ctx.lineTo(cx-14, cy);
    ctx.moveTo(cx+14, cy); ctx.lineTo(cx+40, cy);
    ctx.moveTo(cx, cy-40); ctx.lineTo(cx, cy-14);
    ctx.moveTo(cx, cy+14); ctx.lineTo(cx, cy+40);
    ctx.stroke();

    // QR ë°•ìŠ¤
    if (state.qrBox) {
      ctx.strokeStyle = 'rgba(0,255,136,.9)'; ctx.lineWidth = 3;
      ctx.setLineDash([6,4]); ctx.beginPath();
      const p = state.qrBox.points;
      ctx.moveTo(p[0].x, p[0].y);
      for (let i=1;i<p.length;i++) ctx.lineTo(p[i].x, p[i].y);
      ctx.closePath(); ctx.stroke(); ctx.setLineDash([]);
      ctx.font = '12px system-ui'; ctx.fillStyle='rgba(0,255,136,.9)';
      ctx.fillText(state.qrBox.data || 'QR', p[0].x+4, p[0].y-6);
    }
    requestAnimationFrame(drawHUD);
  }

  function isCenterInQR() {
    if (!state.qrBox) return false;
    const cx = hud.width/2, cy = hud.height/2;
    const pts = state.qrBox.points;
    // ì -ë‹¤ê°í˜• í¬í•¨ íŒì • (ray casting)
    let inside = false;
    for (let i=0, j=pts.length-1; i<pts.length; j=i++) {
      const xi = pts[i].x, yi = pts[i].y;
      const xj = pts[j].x, yj = pts[j].y;
      const intersect = ((yi>cy)!=(yj>cy)) && (cx < (xj - xi) * (cy - yi) / ((yj - yi) || 1e-6) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }

  async function scanLoop() {
    if (video.readyState >= 2) {
      // ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ë¡œ ë³µì‚¬
      scanCanvas.width = hud.width;
      scanCanvas.height = hud.height;
      // ë¹„ë””ì˜¤ë¥¼ ì¢Œìš°ë°˜ì „ ì„¤ì •ì— ë§ì¶° ê·¸ë¦¬ê¸°
      scanCtx.save();
      if (flipX.checked) {
        scanCtx.translate(scanCanvas.width, 0);
        scanCtx.scale(-1, 1);
      }
      scanCtx.drawImage(video, 0, 0, scanCanvas.width, scanCanvas.height);
      scanCtx.restore();
      const imageData = scanCtx.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
      const code = jsQR(imageData.data, scanCanvas.width, scanCanvas.height, { inversionAttempts: "dontInvert" });
      if (code) {
        // location: topLeftCorner, topRightCorner, bottomRightCorner, bottomLeftCorner
        state.qrBox = {
          data: code.data,
          points: [
            code.location.topLeftCorner,
            code.location.topRightCorner,
            code.location.bottomRightCorner,
            code.location.bottomLeftCorner,
          ]
        };
      } else {
        state.qrBox = null;
      }
    }
    requestAnimationFrame(scanLoop);
  }

  // ====== Info ======
  let infoTimer = null;
  function info(t) {
    clearTimeout(infoTimer);
    msg.textContent = t;
    msg.style.opacity = '1';
    infoTimer = setTimeout(()=> msg.style.opacity = '0.0', 2200);
  }

  // ====== WebRTC (1v1) ======
  function setupRTC() {
    const pc = new RTCPeerConnection({
      iceServers:[{urls:'stun:stun.l.google.com:19302'}]
    });
    state.pc = pc;
    const dc = pc.createDataChannel('rb-ar');
    state.dc = dc;

    dc.onopen = ()=> { state.connected = true; info('ìƒíƒœ: ì—°ê²°ë¨'); sendState(); };
    dc.onclose = ()=> { state.connected = false; info('ìƒíƒœ: ì—°ê²° ëŠê¹€'); };

    pc.onicecandidate = (e)=> {
      if (!e.candidate) {
        if (pc.localDescription?.type === 'offer') offerOut.value = btoa(JSON.stringify(pc.localDescription));
        if (pc.localDescription?.type === 'answer') answerOut.value = btoa(JSON.stringify(pc.localDescription));
      }
    };

    pc.ondatachannel = (e)=> {
      state.dc = e.channel;
      state.dc.onopen = ()=> { state.connected = true; info('ìƒíƒœ: ì—°ê²°ë¨'); sendState(); };
      state.dc.onmessage = onMessage;
      state.dc.onclose = ()=> { state.connected = false; info('ìƒíƒœ: ì—°ê²° ëŠê¹€'); };
    };

    state.dc.onmessage = onMessage;

    // ë¯¸ë””ì–´ ì†¡ì¶œì€ ì•ˆ í•¨(ë°ì´í„°ë§Œ)
  }

  function send(obj) {
    if (state.dc && state.dc.readyState === 'open') {
      state.dc.send(JSON.stringify(obj));
    }
  }

  function onMessage(ev) {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.t === 'hit') {
        // ìƒëŒ€ê°€ ë‚˜ë¥¼ ë§ì·„ë‹¤ê³  ì•Œë¦¼
        state.hp = Math.max(0, state.hp - (msg.amt||20));
        updateHUDText();
        info(`í”¼ê²©! by ${msg.by||'Enemy'}`);
        screenHitFlash();
        if (state.hp <= 0) info('ì‚¬ë§... ê²Œì„ ì˜¤ë²„');
        // ë‚´ HP ìƒíƒœ ì•Œë ¤ì£¼ê¸°
        sendState();
      } else if (msg.t === 'state') {
        remoteHpEl.textContent = msg.hp ?? '?';
      } else if (msg.t === 'fire') {
        // ì—°ì¶œ: ìƒëŒ€ ë°œì‚¬ ì•Œë¦¼ í•„ìš”ì‹œ ì¶”ê°€ ê°€ëŠ¥
      } else if (msg.t === 'msg') {
        info(msg.text||'');
      }
    } catch (e) {}
  }

  function sendState() {
    send({ t:'state', name: nameInput.value || 'Player', hp: state.hp });
  }

  // UI wire-up for RTC
  btnCreateOffer.onclick = async ()=> {
    setupRTC();
    const pc = state.pc;
    await pc.setLocalDescription(await pc.createOffer());
    info('Offer ìƒì„± ì™„ë£Œ. ë³µì‚¬í•´ì„œ ì „ë‹¬í•˜ì„¸ìš”.');
  };
  btnCopyOffer.onclick = ()=> { offerOut.select(); document.execCommand('copy'); info('Offer ë³µì‚¬ë¨'); };

  btnCreateAnswer.onclick = async ()=> {
    const s = offerIn.value.trim();
    if (!s) { info('Remote Offer ë¶™ì—¬ë„£ê¸° í•„ìš”'); return; }
    try {
      const offer = JSON.parse(atob(s));
      setupRTC();
      await state.pc.setRemoteDescription(offer);
      await state.pc.setLocalDescription(await state.pc.createAnswer());
      info('Answer ìƒì„± ì™„ë£Œ. ë³µì‚¬í•´ì„œ í˜¸ìŠ¤íŠ¸ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”.');
    } catch (e) { info('Offer íŒŒì‹± ì‹¤íŒ¨'); }
  };
  btnCopyAnswer.onclick = ()=> { answerOut.select(); document.execCommand('copy'); info('Answer ë³µì‚¬ë¨'); };

  btnSetRemoteAnswer.onclick = async ()=> {
    const s = answerIn.value.trim();
    if (!s) { info('Remote Answer ë¶™ì—¬ë„£ê¸° í•„ìš”'); return; }
    try {
      const answer = JSON.parse(atob(s));
      await state.pc.setRemoteDescription(answer);
      info('ì›ê²© Answer ì„¤ì • ì™„ë£Œ. ì—°ê²°ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤...');
    } catch (e) { info('Answer íŒŒì‹± ì‹¤íŒ¨'); }
  };

  toggleConnect.onclick = ()=> { connectPanel.hidden = !connectPanel.hidden; };

  // ì¢Œìš°ë°˜ì „ í† ê¸€
  flipX.onchange = ()=> {
    if (flipX.checked) { video.classList.add('flipX'); } else { video.classList.remove('flipX'); }
  };

  // ====== Init ======
  (async function init(){
    await startCamera();
    keepAwake(true);
    resize();
    drawHUD();
    scanLoop();
    updateHUDText();
    const kick = ()=> { audioCtx.resume?.(); removeEventListener('touchend', kick); };
    addEventListener('touchend', kick, {once:true});
  })();

  addEventListener('pagehide', ()=> keepAwake(false));
  </script>
</body>
</html>
